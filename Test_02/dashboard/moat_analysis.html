<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>해자 분석 대시보드 - Stock Research ONE</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .monitor-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0a0a 0%, #0a1a1a 100%);
        }

        /* Header */
        .monitor-header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid #334155;
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #10b981;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .page-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            color: #10b981;
        }

        .nav-link {
            color: #94a3b8;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s;
        }
        .nav-link:hover { color: #f8fafc; }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }

        /* KPI Row */
        .kpi-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .kpi-sub {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Chart Grid */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.25rem;
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-title-icon {
            width: 20px;
            height: 20px;
            color: #10b981;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .chart-container.heatmap {
            height: 320px;
        }

        /* Heatmap */
        .heatmap-grid {
            display: grid;
            grid-template-columns: 40px repeat(6, 1fr);
            grid-template-rows: repeat(7, auto) 30px;
            gap: 3px;
            height: 100%;
            align-items: stretch;
        }

        .heatmap-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            min-height: 38px;
            cursor: default;
            transition: transform 0.15s;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            z-index: 1;
        }

        .heatmap-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #94a3b8;
            font-weight: 600;
        }

        .heatmap-corner { }

        /* Sector Bar */
        .sector-bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .sector-name {
            width: 120px;
            font-size: 0.8rem;
            text-align: right;
            color: #cbd5e1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sector-bar-bg {
            flex: 1;
            height: 22px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 4px;
            overflow: hidden;
        }

        .sector-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        .sector-count {
            width: 40px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Table Section */
        .table-section {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 1.25rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .table-filters {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-input {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: #f8fafc;
            font-size: 0.8rem;
            outline: none;
        }

        .filter-input:focus {
            border-color: #10b981;
        }

        .filter-select {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            color: #f8fafc;
            font-size: 0.8rem;
            outline: none;
        }

        .stock-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stock-table th {
            text-align: left;
            padding: 0.6rem 0.75rem;
            font-size: 0.75rem;
            color: #94a3b8;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .stock-table th:hover {
            color: #10b981;
        }

        .stock-table td {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
        }

        .stock-table tr:hover td {
            background: rgba(16, 185, 129, 0.05);
        }

        .score-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 28px;
            text-align: center;
        }

        .score-0 { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .score-1 { background: rgba(249, 115, 22, 0.2); color: #f97316; }
        .score-2 { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .score-3 { background: rgba(163, 230, 53, 0.2); color: #a3e635; }
        .score-4 { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .score-5 { background: rgba(16, 185, 129, 0.2); color: #10b981; }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .page-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 0.4rem 0.75rem;
            color: #cbd5e1;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .page-btn:hover { border-color: #10b981; color: #10b981; }
        .page-btn.active { background: #10b981; color: white; border-color: #10b981; }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .page-info {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Detail Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 1.5rem;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .detail-item {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .detail-label {
            font-size: 0.7rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #334155;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: #ef4444;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .kpi-row { grid-template-columns: repeat(3, 1fr); }
            .chart-grid { grid-template-columns: 1fr; }
            .main-content { padding: 1rem; }
        }

        @media (max-width: 600px) {
            .kpi-row { grid-template-columns: repeat(2, 1fr); }
        }

        /* ─── Data Source Footer ─── */
        .ds-footer { margin: 2rem auto 1rem; max-width: 1400px; }
        .ds-footer-toggle {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(30,41,59,0.6); border: 1px solid #334155; border-radius: 8px;
            padding: 0.6rem 1rem; cursor: pointer; width: 100%; color: #94a3b8; font-size: 0.8rem;
            transition: background 0.2s;
        }
        .ds-footer-toggle:hover { background: rgba(30,41,59,0.9); }
        .ds-footer-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.78rem; }
        .ds-footer-table th { text-align: left; color: #64748b; padding: 0.4rem 0.6rem; border-bottom: 1px solid #1e293b; font-weight: 500; }
        .ds-footer-table td { padding: 0.4rem 0.6rem; color: #cbd5e1; border-bottom: 1px solid rgba(30,41,59,0.5); }
        .ds-footer-table tr:hover td { background: rgba(51,65,85,0.3); }
        .ds-status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
        .ds-badge { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.68rem; font-weight: 600; }
        .ds-badge-auto { background: rgba(34,197,94,0.15); color: #22c55e; }
        .ds-badge-manual { background: rgba(100,116,139,0.2); color: #94a3b8; }
        .ds-badge-static { background: rgba(100,116,139,0.2); color: #64748b; }
        .ds-badge-ondemand { background: rgba(139,92,246,0.15); color: #a78bfa; }
        .ds-detail-row td { padding: 0.3rem 0.6rem 0.5rem; color: #64748b; font-size: 0.72rem; border-bottom: 1px solid rgba(30,41,59,0.3); }
        .ds-detail-row a { color: #60a5fa; text-decoration: none; }
        .ds-detail-row a:hover { text-decoration: underline; }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        const API_BASE = 'http://localhost:8000/api/v1';

        // ── Utility ─────────────────────────────────
        function formatNumber(n) {
            if (n == null) return '-';
            return n.toLocaleString('ko-KR');
        }

        function getScoreColor(score) {
            const colors = ['#ef4444', '#f97316', '#eab308', '#a3e635', '#22c55e', '#10b981'];
            return colors[Math.min(score, 5)] || '#64748b';
        }

        function getHeatmapColor(count, maxCount) {
            if (count === 0) return 'rgba(30, 41, 59, 0.3)';
            const intensity = Math.min(count / Math.max(maxCount, 1), 1);
            const r = Math.round(16 + (16 - 16) * intensity);
            const g = Math.round(41 + (185 - 41) * intensity);
            const b = Math.round(59 + (129 - 59) * intensity);
            return `rgba(${r}, ${g}, ${b}, ${0.2 + intensity * 0.8})`;
        }

        // ── KPI Card ────────────────────────────────
        const KpiCard = React.memo(function KpiCard({ value, label, sub, color }) {
            return (
                <div className="kpi-card">
                    <div className="kpi-value" style={{ color: color || '#f8fafc' }}>
                        {value}
                    </div>
                    <div className="kpi-label">{label}</div>
                    {sub && <div className="kpi-sub">{sub}</div>}
                </div>
            );
        });

        // ── Bar Chart Component ─────────────────────
        const BarChart = React.memo(function BarChart({ data, label, colors }) {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !data) return;

                if (chartRef.current) chartRef.current.destroy();

                const labels = Object.keys(data).sort((a, b) => Number(a) - Number(b));
                const values = labels.map(k => data[k]);

                chartRef.current = new Chart(canvasRef.current, {
                    type: 'bar',
                    data: {
                        labels: labels.map(l => `${l}점`),
                        datasets: [{
                            label: label,
                            data: values,
                            backgroundColor: colors || labels.map(l => getScoreColor(Number(l))),
                            borderRadius: 6,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                                titleColor: '#f8fafc',
                                bodyColor: '#cbd5e1',
                                borderColor: '#334155',
                                borderWidth: 1,
                                cornerRadius: 8,
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#94a3b8', font: { size: 12 } },
                                grid: { display: false },
                            },
                            y: {
                                ticks: { color: '#64748b', font: { size: 11 } },
                                grid: { color: 'rgba(51, 65, 85, 0.3)' },
                            }
                        }
                    }
                });

                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, label, colors]);

            return <canvas ref={canvasRef} />;
        });

        // ── Heatmap Component ───────────────────────
        const Heatmap = React.memo(function Heatmap({ matrix }) {
            if (!matrix) return null;

            const maxCount = useMemo(() => {
                return Math.max(...Object.values(matrix), 1);
            }, [matrix]);

            const cells = [];

            // Header row (투자가치 labels)
            cells.push(<div key="corner" className="heatmap-corner heatmap-label"></div>);
            for (let v = 0; v <= 5; v++) {
                cells.push(
                    <div key={`h-${v}`} className="heatmap-label">V={v}</div>
                );
            }

            // Data rows (해자 5→0 top to bottom)
            for (let m = 5; m >= 0; m--) {
                cells.push(
                    <div key={`rl-${m}`} className="heatmap-label">M={m}</div>
                );
                for (let v = 0; v <= 5; v++) {
                    const count = matrix[`${m},${v}`] || 0;
                    const bg = getHeatmapColor(count, maxCount);
                    cells.push(
                        <div
                            key={`c-${m}-${v}`}
                            className="heatmap-cell"
                            style={{ background: bg }}
                            title={`해자 ${m}, 투자가치 ${v}: ${count}개`}
                        >
                            {count > 0 ? count : ''}
                        </div>
                    );
                }
            }

            // Footer labels
            cells.push(<div key="fl" className="heatmap-label" style={{ fontSize: '0.65rem' }}>해자↑</div>);
            for (let v = 0; v <= 5; v++) {
                cells.push(
                    <div key={`fl-${v}`} className="heatmap-label" style={{ fontSize: '0.65rem' }}>
                        {v === 0 ? '투자가치→' : ''}
                    </div>
                );
            }

            return (
                <div className="heatmap-grid">
                    {cells}
                </div>
            );
        });

        // ── Sector Chart (Horizontal Bars) ──────────
        const SectorChart = React.memo(function SectorChart({ sectors }) {
            if (!sectors) return null;

            const sorted = useMemo(() => {
                return Object.entries(sectors)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 15);
            }, [sectors]);

            const maxVal = sorted.length > 0 ? sorted[0][1] : 1;

            const greens = [
                '#10b981', '#059669', '#047857', '#065f46', '#064e3b',
                '#34d399', '#6ee7b7', '#a7f3d0', '#d1fae5', '#ecfdf5',
                '#0d9488', '#14b8a6', '#2dd4bf', '#5eead4', '#99f6e4',
            ];

            return (
                <div style={{ overflowY: 'auto', maxHeight: 280 }}>
                    {sorted.map(([name, count], i) => (
                        <div key={name} className="sector-bar-row">
                            <div className="sector-name" title={name}>{name}</div>
                            <div className="sector-bar-bg">
                                <div
                                    className="sector-bar-fill"
                                    style={{
                                        width: `${(count / maxVal) * 100}%`,
                                        background: greens[i % greens.length],
                                    }}
                                />
                            </div>
                            <div className="sector-count">{count}</div>
                        </div>
                    ))}
                </div>
            );
        });

        // ── Stock Detail Modal ──────────────────────
        const StockModal = React.memo(function StockModal({ stock, onClose }) {
            if (!stock) return null;

            const d = stock.details || {};

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="modal-title">
                            <span style={{ color: '#10b981' }}>{stock.name}</span>
                            <span style={{ color: '#64748b', fontSize: '0.85rem', fontWeight: 400 }}>
                                ({stock.ticker})
                            </span>
                        </div>

                        <div className="detail-grid">
                            <div className="detail-item">
                                <div className="detail-label">해자 점수</div>
                                <div className="detail-value" style={{ color: getScoreColor(stock.moat_score) }}>
                                    {stock.moat_score != null ? `${stock.moat_score}/5` : '-'}
                                </div>
                            </div>
                            <div className="detail-item">
                                <div className="detail-label">투자가치</div>
                                <div className="detail-value" style={{ color: getScoreColor(stock.investment_value) }}>
                                    {stock.investment_value != null ? `${stock.investment_value}/5` : '-'}
                                </div>
                            </div>
                            <div className="detail-item">
                                <div className="detail-label">섹터 (BM)</div>
                                <div className="detail-value" style={{ fontSize: '0.85rem' }}>
                                    {stock.bm || '-'}
                                </div>
                            </div>
                            <div className="detail-item">
                                <div className="detail-label">평가일자</div>
                                <div className="detail-value" style={{ fontSize: '0.85rem' }}>
                                    {stock.eval_date || '-'}
                                </div>
                            </div>

                            {d.ttm_revenue && (
                                <div className="detail-item">
                                    <div className="detail-label">TTM 매출</div>
                                    <div className="detail-value" style={{ fontSize: '0.9rem' }}>{d.ttm_revenue}</div>
                                </div>
                            )}
                            {d.op_income && (
                                <div className="detail-item">
                                    <div className="detail-label">영업이익 (마진)</div>
                                    <div className="detail-value" style={{ fontSize: '0.9rem' }}>
                                        {d.op_income} ({d.op_margin || '-'})
                                    </div>
                                </div>
                            )}
                            {d.op_multiple && (
                                <div className="detail-item">
                                    <div className="detail-label">OP Multiple</div>
                                    <div className="detail-value" style={{ fontSize: '0.9rem' }}>
                                        {d.op_multiple}x
                                    </div>
                                </div>
                            )}
                            {d.market_cap && (
                                <div className="detail-item">
                                    <div className="detail-label">시가총액</div>
                                    <div className="detail-value" style={{ fontSize: '0.9rem' }}>{d.market_cap}</div>
                                </div>
                            )}
                            {d.current_price && (
                                <div className="detail-item">
                                    <div className="detail-label">현재가</div>
                                    <div className="detail-value" style={{ fontSize: '0.9rem' }}>
                                        {formatNumber(d.current_price)}원
                                    </div>
                                </div>
                            )}
                            {d.evidence_count != null && (
                                <div className="detail-item">
                                    <div className="detail-label">증거 건수 / 품질</div>
                                    <div className="detail-value" style={{ fontSize: '0.9rem' }}>
                                        {d.evidence_count}건 (q{d.evidence_quality})
                                    </div>
                                </div>
                            )}
                            {d.growth_adj != null && (
                                <div className="detail-item">
                                    <div className="detail-label">성장 조정</div>
                                    <div className="detail-value" style={{
                                        fontSize: '0.9rem',
                                        color: d.growth_adj > 0 ? '#22c55e' : d.growth_adj < 0 ? '#ef4444' : '#94a3b8'
                                    }}>
                                        {d.growth_adj > 0 ? '+' : ''}{d.growth_adj}
                                    </div>
                                </div>
                            )}
                            {d.data_source && (
                                <div className="detail-item" style={{ gridColumn: '1 / -1' }}>
                                    <div className="detail-label">데이터 소스</div>
                                    <div className="detail-value" style={{ fontSize: '0.85rem', color: '#94a3b8' }}>
                                        {d.data_source}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div style={{ marginTop: '1.5rem', textAlign: 'center' }}>
                            <button
                                onClick={onClose}
                                style={{
                                    background: 'rgba(16, 185, 129, 0.15)',
                                    border: '1px solid rgba(16, 185, 129, 0.3)',
                                    color: '#10b981',
                                    padding: '0.5rem 2rem',
                                    borderRadius: '8px',
                                    cursor: 'pointer',
                                    fontSize: '0.9rem',
                                }}
                            >
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            );
        });

        // ── Stock Table ─────────────────────────────
        const StockTable = React.memo(function StockTable({ stocks, total, page, pageSize, onPageChange, onStockClick, sortCol, sortDesc, onSort }) {
            const totalPages = Math.ceil(total / pageSize);

            const columns = [
                { key: 'ticker', label: '코드', width: '80px' },
                { key: 'name', label: '종목명', width: 'auto' },
                { key: 'moat_score', label: '해자', width: '60px' },
                { key: 'investment_value', label: '투자가치', width: '80px' },
                { key: 'bm', label: '섹터', width: '160px' },
                { key: 'eval_date', label: '평가일', width: '100px' },
            ];

            return (
                <div>
                    <table className="stock-table">
                        <thead>
                            <tr>
                                {columns.map(col => (
                                    <th
                                        key={col.key}
                                        style={{ width: col.width }}
                                        onClick={() => onSort(col.key)}
                                    >
                                        {col.label}
                                        {sortCol === col.key && (sortDesc ? ' ▼' : ' ▲')}
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody>
                            {stocks.map((s, i) => (
                                <tr key={s.ticker + '-' + i} onClick={() => onStockClick(s)} style={{ cursor: 'pointer' }}>
                                    <td style={{ color: '#64748b', fontFamily: 'monospace' }}>{s.ticker}</td>
                                    <td style={{ fontWeight: 500 }}>{s.name}</td>
                                    <td>
                                        {s.moat_score != null ? (
                                            <span className={`score-badge score-${s.moat_score}`}>{s.moat_score}</span>
                                        ) : '-'}
                                    </td>
                                    <td>
                                        {s.investment_value != null ? (
                                            <span className={`score-badge score-${s.investment_value}`}>{s.investment_value}</span>
                                        ) : '-'}
                                    </td>
                                    <td style={{ fontSize: '0.75rem', color: '#94a3b8' }}>{s.bm || '-'}</td>
                                    <td style={{ fontSize: '0.75rem', color: '#64748b' }}>{s.eval_date || '-'}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>

                    <div className="pagination">
                        <button className="page-btn" onClick={() => onPageChange(0)} disabled={page === 0}>
                            ««
                        </button>
                        <button className="page-btn" onClick={() => onPageChange(page - 1)} disabled={page === 0}>
                            «
                        </button>
                        <span className="page-info">
                            {page + 1} / {totalPages} ({formatNumber(total)}건)
                        </span>
                        <button className="page-btn" onClick={() => onPageChange(page + 1)} disabled={page >= totalPages - 1}>
                            »
                        </button>
                        <button className="page-btn" onClick={() => onPageChange(totalPages - 1)} disabled={page >= totalPages - 1}>
                            »»
                        </button>
                    </div>
                </div>
            );
        });

        // ── Data Sources ───────────────────────────────
        const DATA_SOURCES = [
            { name: "DART 연간재무", db_table: null, collector_key: null, type: "on-demand", api_url: "https://opendart.fss.or.kr/", script: "scripts/dart_client.py" },
            { name: "Oracle DB (TTM)", db_table: null, collector_key: null, type: "on-demand", script: "scripts/moat_analysis/oracle_client.py" },
            { name: "해자 분석 결과", db_table: "moat_evaluations", collector_key: null, type: "on-demand", script: "scripts/moat_analysis/analyze_with_evidence.py" },
        ];

        // ─── DataSourceFooter ─────────────────────────────────
        const DataSourceFooter = React.memo(() => {
            const [expanded, setExpanded] = useState(false);
            const [status, setStatus] = useState(null);
            const [detailIdx, setDetailIdx] = useState(null);

            useEffect(() => {
                fetch(`${API_BASE}/collector/status`)
                    .then(r => r.json()).then(setStatus).catch(() => {});
            }, []);

            const getStatusColor = (src) => {
                if (!src.collector_key || !status?.collectors?.[src.collector_key]) {
                    const m = { manual: '#64748b', static: '#64748b', 'on-demand': '#8b5cf6' };
                    return m[src.type] || '#475569';
                }
                const c = status.collectors[src.collector_key];
                if (!c || c.status !== 'success') return '#ef4444';
                const hours = (Date.now() - new Date(c.created_at).getTime()) / 3600000;
                return hours < 1 ? '#22c55e' : hours < 24 ? '#eab308' : '#ef4444';
            };

            const getLastTime = (src) => {
                if (!src.collector_key || !status?.collectors?.[src.collector_key]) return '-';
                const c = status.collectors[src.collector_key];
                if (!c?.created_at) return '-';
                return new Date(c.created_at).toLocaleString('ko-KR', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
            };

            const getCount = (src) => {
                if (!src.db_table || !status?.table_counts) return '-';
                const count = status.table_counts[src.db_table];
                return count != null ? count.toLocaleString() : '-';
            };

            const latestTime = DATA_SOURCES
                .map(s => s.collector_key && status?.collectors?.[s.collector_key]?.created_at)
                .filter(Boolean).sort().pop();

            const typeBadge = (type) => {
                const labels = { auto: '자동', manual: '수동', static: '정적', 'on-demand': '요청시' };
                const cls = type === 'on-demand' ? 'ondemand' : type;
                return React.createElement('span', { className: `ds-badge ds-badge-${cls}` }, labels[type] || type);
            };

            return (
                <div className="ds-footer">
                    <button className="ds-footer-toggle" onClick={() => setExpanded(!expanded)}>
                        <span>
                            {expanded ? '\u25BE' : '\u25B8'} 데이터 소스 ({DATA_SOURCES.length}개
                            {latestTime ? ` \u00b7 마지막 수집 ${new Date(latestTime).toLocaleString('ko-KR', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' })}` : ''})
                        </span>
                        <span style={{fontSize:'0.72rem'}}>{expanded ? '접기' : '펼치기'}</span>
                    </button>
                    {expanded && (
                        <table className="ds-footer-table">
                            <thead><tr>
                                <th>소스</th><th>DB 테이블</th><th>건수</th><th>마지막 수집</th><th>유형</th><th>상태</th>
                            </tr></thead>
                            <tbody>
                                {DATA_SOURCES.map((src, i) => (
                                    <React.Fragment key={i}>
                                        <tr onClick={() => setDetailIdx(detailIdx === i ? null : i)} style={{cursor:'pointer'}}>
                                            <td>{src.name}</td>
                                            <td><code style={{fontSize:'0.72rem',color:'#94a3b8'}}>{src.db_table || '-'}</code></td>
                                            <td>{getCount(src)}</td>
                                            <td>{getLastTime(src)}</td>
                                            <td>{typeBadge(src.type)}</td>
                                            <td><span className="ds-status-dot" style={{backgroundColor: getStatusColor(src)}}></span></td>
                                        </tr>
                                        {detailIdx === i && (
                                            <tr className="ds-detail-row">
                                                <td colSpan={6}>
                                                    {src.api_url && <div>API: <a href={src.api_url} target="_blank" rel="noopener noreferrer">{src.api_url}</a></div>}
                                                    {src.script && <div>Script: <code>{src.script}</code></div>}
                                                </td>
                                            </tr>
                                        )}
                                    </React.Fragment>
                                ))}
                            </tbody>
                        </table>
                    )}
                </div>
            );
        });

        // ── Main App ────────────────────────────────
        function App() {
            const [summary, setSummary] = useState(null);
            const [stocks, setStocks] = useState([]);
            const [total, setTotal] = useState(0);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Filters
            const [search, setSearch] = useState('');
            const [minMoat, setMinMoat] = useState(0);
            const [minValue, setMinValue] = useState(0);
            const [sectorFilter, setSectorFilter] = useState('');
            const [page, setPage] = useState(0);
            const [pageSize] = useState(50);
            const [sortCol, setSortCol] = useState('investment_value');
            const [sortDesc, setSortDesc] = useState(true);

            // Modal
            const [selectedStock, setSelectedStock] = useState(null);

            // Load summary
            useEffect(() => {
                fetch(`${API_BASE}/moat-dashboard`)
                    .then(r => {
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .then(data => {
                        setSummary(data);
                        setLoading(false);
                    })
                    .catch(err => {
                        setError(err.message);
                        setLoading(false);
                    });
            }, []);

            // Load stocks
            useEffect(() => {
                const params = new URLSearchParams({
                    min_moat: minMoat,
                    min_value: minValue,
                    limit: pageSize,
                    offset: page * pageSize,
                });
                if (sectorFilter) params.set('sector', sectorFilter);

                fetch(`${API_BASE}/moat-dashboard/stocks?${params}`)
                    .then(r => r.json())
                    .then(data => {
                        let filtered = data.stocks || [];
                        // Client-side search filter
                        if (search) {
                            const q = search.toLowerCase();
                            filtered = filtered.filter(s =>
                                s.name.toLowerCase().includes(q) ||
                                s.ticker.includes(q)
                            );
                        }
                        // Client-side sort
                        filtered.sort((a, b) => {
                            const av = a[sortCol] ?? -1;
                            const bv = b[sortCol] ?? -1;
                            if (av < bv) return sortDesc ? 1 : -1;
                            if (av > bv) return sortDesc ? -1 : 1;
                            return 0;
                        });
                        setStocks(filtered);
                        setTotal(data.total || 0);
                    })
                    .catch(() => {});
            }, [minMoat, minValue, sectorFilter, page, pageSize, search, sortCol, sortDesc]);

            const handleSort = useCallback((col) => {
                if (col === sortCol) {
                    setSortDesc(prev => !prev);
                } else {
                    setSortCol(col);
                    setSortDesc(true);
                }
            }, [sortCol]);

            const handlePageChange = useCallback((p) => {
                setPage(Math.max(0, p));
            }, []);

            const sectorOptions = useMemo(() => {
                if (!summary?.sectors) return [];
                return Object.keys(summary.sectors).sort();
            }, [summary]);

            // ── Render ──────────────────────────────
            if (loading) {
                return (
                    <div className="monitor-container">
                        <div className="loading">
                            <div className="spinner"></div>
                            <div style={{ color: '#94a3b8' }}>데이터 로딩 중...</div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="monitor-container">
                        <div className="main-content">
                            <div className="error-box">
                                <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>API 연결 실패</div>
                                <div>{error}</div>
                                <div style={{ marginTop: '1rem', fontSize: '0.85rem', color: '#94a3b8' }}>
                                    Backend 서버가 실행 중인지 확인하세요: uvicorn app.main:app --port 8000
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            const meta = summary?.meta || {};
            const dist = summary?.distributions || {};

            return (
                <div className="monitor-container">
                    {/* Header */}
                    <header className="monitor-header">
                        <div className="header-content">
                            <div className="header-left">
                                <div className="logo">
                                    <div className="logo-icon">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                        </svg>
                                    </div>
                                    해자 분석 대시보드
                                </div>
                                <span className="page-badge">
                                    {formatNumber(meta.evaluated_count)}종목 분석완료
                                </span>
                            </div>
                            <div>
                                <a href="index.html" className="nav-link">← 메인 대시보드</a>
                            </div>
                        </div>
                    </header>

                    <div className="main-content">
                        {/* KPI Row */}
                        <div className="kpi-row">
                            <KpiCard
                                value={formatNumber(meta.evaluated_count)}
                                label="분석 완료"
                                sub={`전체 ${formatNumber(meta.total_stocks)}종목`}
                                color="#10b981"
                            />
                            <KpiCard
                                value={meta.avg_moat?.toFixed(1) || '0'}
                                label="평균 해자"
                                sub="0~5점"
                                color="#22c55e"
                            />
                            <KpiCard
                                value={meta.avg_value?.toFixed(1) || '0'}
                                label="평균 투자가치"
                                sub="0~5점"
                                color="#3b82f6"
                            />
                            <KpiCard
                                value={formatNumber(meta.high_value_count)}
                                label="고가치 종목 (≥4)"
                                sub={`${((meta.high_value_count / meta.evaluated_count) * 100).toFixed(1)}%`}
                                color="#f59e0b"
                            />
                            <KpiCard
                                value={formatNumber(meta.unevaluated_count)}
                                label="미평가"
                                sub={meta.extracted_at ? `기준: ${meta.extracted_at.split('T')[0]}` : ''}
                                color="#64748b"
                            />
                        </div>

                        {/* Charts Grid */}
                        <div className="chart-grid">
                            {/* Moat Distribution */}
                            <div className="chart-card">
                                <div className="chart-title">
                                    <svg className="chart-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                    </svg>
                                    해자 점수 분포
                                </div>
                                <div className="chart-container">
                                    <BarChart data={dist.moat} label="해자 점수" />
                                </div>
                            </div>

                            {/* Investment Value Distribution */}
                            <div className="chart-card">
                                <div className="chart-title">
                                    <svg className="chart-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                    </svg>
                                    투자가치 분포
                                </div>
                                <div className="chart-container">
                                    <BarChart
                                        data={dist.investment_value}
                                        label="투자가치"
                                        colors={['#ef4444', '#f97316', '#eab308', '#3b82f6', '#6366f1', '#8b5cf6']}
                                    />
                                </div>
                            </div>

                            {/* Heatmap */}
                            <div className="chart-card">
                                <div className="chart-title">
                                    <svg className="chart-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                                        <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                                    </svg>
                                    해자 × 투자가치 매트릭스
                                </div>
                                <div className="chart-container heatmap">
                                    <Heatmap matrix={dist.matrix} />
                                </div>
                            </div>

                            {/* Sector Distribution */}
                            <div className="chart-card">
                                <div className="chart-title">
                                    <svg className="chart-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                                    </svg>
                                    섹터 분포 (Top 15)
                                </div>
                                <div className="chart-container">
                                    <SectorChart sectors={summary?.sectors} />
                                </div>
                            </div>
                        </div>

                        {/* Stock Table */}
                        <div className="table-section">
                            <div className="table-header">
                                <div className="chart-title" style={{ marginBottom: 0 }}>
                                    <svg className="chart-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                        <path d="M3 3h18v18H3z"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/>
                                    </svg>
                                    종목 목록
                                </div>
                                <div className="table-filters">
                                    <input
                                        className="filter-input"
                                        placeholder="종목명/코드 검색..."
                                        value={search}
                                        onChange={e => { setSearch(e.target.value); setPage(0); }}
                                        style={{ width: '180px' }}
                                    />
                                    <select
                                        className="filter-select"
                                        value={minMoat}
                                        onChange={e => { setMinMoat(Number(e.target.value)); setPage(0); }}
                                    >
                                        <option value="0">해자 전체</option>
                                        <option value="1">해자 ≥ 1</option>
                                        <option value="2">해자 ≥ 2</option>
                                        <option value="3">해자 ≥ 3</option>
                                        <option value="4">해자 ≥ 4</option>
                                        <option value="5">해자 = 5</option>
                                    </select>
                                    <select
                                        className="filter-select"
                                        value={minValue}
                                        onChange={e => { setMinValue(Number(e.target.value)); setPage(0); }}
                                    >
                                        <option value="0">투자가치 전체</option>
                                        <option value="1">투자가치 ≥ 1</option>
                                        <option value="2">투자가치 ≥ 2</option>
                                        <option value="3">투자가치 ≥ 3</option>
                                        <option value="4">투자가치 ≥ 4</option>
                                        <option value="5">투자가치 = 5</option>
                                    </select>
                                    <select
                                        className="filter-select"
                                        value={sectorFilter}
                                        onChange={e => { setSectorFilter(e.target.value); setPage(0); }}
                                    >
                                        <option value="">섹터 전체</option>
                                        {sectorOptions.map(s => (
                                            <option key={s} value={s}>{s}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <StockTable
                                stocks={stocks}
                                total={total}
                                page={page}
                                pageSize={pageSize}
                                onPageChange={handlePageChange}
                                onStockClick={setSelectedStock}
                                sortCol={sortCol}
                                sortDesc={sortDesc}
                                onSort={handleSort}
                            />
                        </div>
                    </div>

                    <DataSourceFooter />

                    {/* Modal */}
                    {selectedStock && (
                        <StockModal stock={selectedStock} onClose={() => setSelectedStock(null)} />
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
