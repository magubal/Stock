<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligence Board — Stock Research ONE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }

        /* Header */
        .header { background: #1e293b; border-bottom: 1px solid #334155; padding: 0.75rem 2rem; display: flex; align-items: center; gap: 1rem; }
        .header a { color: #94a3b8; text-decoration: none; font-size: 0.875rem; }
        .header a:hover { color: #f8fafc; }
        .header h1 { font-size: 1.25rem; color: #f8fafc; flex: 1; }
        .purpose-bar { background: #111827; border-bottom: 1px solid #1f2937; padding: 0.6rem 2rem; display: flex; align-items: baseline; gap: 0.5rem; flex-wrap: wrap; }
        .purpose-title { font-size: 0.75rem; font-weight: 700; color: #60a5fa; text-transform: uppercase; letter-spacing: 0.06em; }
        .purpose-desc { font-size: 0.8rem; color: #cbd5e1; }
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; display: inline-block; }
        .badge-blue { background: #3b82f6; color: white; }
        .badge-green { background: #22c55e; color: white; }
        .badge-amber { background: #f59e0b; color: #1e293b; }
        .badge-red { background: #ef4444; color: white; }
        .badge-gray { background: #475569; color: #e2e8f0; }
        .badge-purple { background: #a855f7; color: white; }
        .btn { background: #334155; border: 1px solid #475569; color: #94a3b8; padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .btn:hover { background: #475569; color: #f8fafc; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: #3b82f6; border-color: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #22c55e; border-color: #22c55e; color: white; }
        .btn-success:hover { background: #16a34a; }
        .btn-danger { background: #ef4444; border-color: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }

        /* Main layout: Split panel */
        .main { display: flex; height: calc(100vh - 52px); overflow: hidden; }
        .signal-feed { width: 35%; min-width: 340px; border-right: 1px solid #334155; display: flex; flex-direction: column; }
        .detail-panel { flex: 1; overflow-y: auto; }

        /* Signal Feed */
        .feed-header { padding: 1rem 1.25rem; border-bottom: 1px solid #334155; background: #1e293b; }
        .feed-header h2 { font-size: 0.95rem; color: #f8fafc; margin-bottom: 0.5rem; }
        .feed-controls { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .feed-controls select, .feed-controls input { background: #0f172a; border: 1px solid #334155; color: #e2e8f0; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; }
        .feed-controls input { min-width: 180px; flex: 1 1 180px; }
        .feed-list { flex: 1; overflow-y: auto; padding: 0.5rem; }

        /* Signal Card */
        .signal-card { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 0.875rem; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .signal-card:hover { border-color: #3b82f6; background: #1e293b; }
        .signal-card.active { border-color: #3b82f6; background: #172554; }
        .signal-card-top { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.375rem; }
        .conf-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .conf-text { font-size: 0.8rem; font-weight: 700; }
        .signal-card-title { font-size: 0.875rem; font-weight: 600; color: #f8fafc; flex: 1; }
        .signal-card-meta { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.25rem; font-size: 0.7rem; color: #64748b; }
        .signal-card-action { font-size: 0.75rem; color: #94a3b8; margin-top: 0.375rem; line-height: 1.4; }
        .signal-card-bottom { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.375rem; font-size: 0.7rem; color: #64748b; }
        .gap-warn { color: #f59e0b; }

        /* Detail Panel */
        .detail-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: #475569; font-size: 1rem; }
        .detail-content { padding: 1.5rem; }
        .detail-header { margin-bottom: 1.5rem; }
        .detail-header h2 { font-size: 1.25rem; color: #f8fafc; margin-bottom: 0.5rem; }
        .detail-header p { font-size: 0.85rem; color: #94a3b8; line-height: 1.5; }
        .detail-conf { display: flex; align-items: center; gap: 0.75rem; margin-top: 0.75rem; }
        .conf-bar-bg { flex: 1; max-width: 200px; height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
        .conf-bar { height: 100%; border-radius: 4px; transition: width 0.3s; }

        /* Detail Sections */
        .detail-section { background: #1e293b; border: 1px solid #334155; border-radius: 8px; margin-bottom: 1rem; }
        .detail-section-header { padding: 0.75rem 1rem; border-bottom: 1px solid #334155; font-size: 0.8rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; display: flex; align-items: center; gap: 0.5rem; }
        .detail-section-body { padding: 1rem; }

        /* Evidence items */
        .evidence-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid #1e293b; }
        .evidence-item:last-child { border-bottom: none; }
        .evidence-module { font-size: 0.7rem; color: #3b82f6; background: #172554; padding: 2px 6px; border-radius: 4px; min-width: 80px; text-align: center; }
        .evidence-label { font-size: 0.8rem; color: #e2e8f0; flex: 1; }
        .evidence-value { font-size: 0.875rem; font-weight: 600; color: #f8fafc; }

        /* AI Interpretation */
        .ai-text { font-size: 0.85rem; color: #e2e8f0; line-height: 1.6; margin-bottom: 0.75rem; }
        .ai-hypothesis { background: #172554; border-left: 3px solid #3b82f6; padding: 0.5rem 0.75rem; border-radius: 0 4px 4px 0; font-size: 0.8rem; color: #93c5fd; margin-bottom: 0.75rem; }
        .ai-actions { list-style: none; }
        .ai-actions li { font-size: 0.8rem; color: #94a3b8; padding: 0.25rem 0; }
        .ai-actions li::before { content: "→ "; color: #22c55e; }
        .ai-unavailable { color: #64748b; font-size: 0.85rem; font-style: italic; }

        /* Gap items */
        .gap-item { background: #1c1917; border: 1px solid #44403c; border-radius: 6px; padding: 0.625rem; margin-bottom: 0.5rem; }
        .gap-item:last-child { margin-bottom: 0; }
        .gap-module { font-size: 0.75rem; color: #f59e0b; font-weight: 600; }
        .gap-reason { font-size: 0.8rem; color: #d6d3d1; margin-top: 0.25rem; }
        .gap-impact { font-size: 0.7rem; color: #78716c; margin-top: 0.125rem; }

        /* Recommendation items */
        .rec-item { background: #022c22; border: 1px solid #065f46; border-radius: 6px; padding: 0.625rem; margin-bottom: 0.5rem; }
        .rec-item:last-child { margin-bottom: 0; }
        .rec-name { font-size: 0.8rem; color: #22c55e; font-weight: 600; }
        .rec-synergy { font-size: 0.8rem; color: #a7f3d0; margin-top: 0.25rem; line-height: 1.4; }
        .rec-boost { font-size: 0.7rem; color: #4ade80; margin-top: 0.25rem; }
        .rec-url { font-size: 0.7rem; margin-top: 0.25rem; }
        .rec-url a { color: #6ee7b7; }

        /* Action buttons */
        .action-bar { display: flex; gap: 0.75rem; padding: 1rem 0; }

        /* Loading / Empty */
        .loading { text-align: center; padding: 2rem; color: #475569; }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #334155; border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Generate bar */
        .generate-bar { padding: 0.75rem 1.25rem; border-bottom: 1px solid #334155; background: #172554; display: flex; align-items: center; gap: 0.75rem; }
        .generate-bar .status { font-size: 0.8rem; color: #93c5fd; flex: 1; }
        .generate-bar .summary { font-size: 0.75rem; color: #bfdbfe; white-space: nowrap; }

        /* DEMO banner */
        .demo-banner { background: #7f1d1d; border-bottom: 1px solid #991b1b; padding: 0.5rem 2rem; font-size: 0.75rem; color: #fca5a5; display: flex; align-items: center; gap: 0.5rem; }
        .demo-banner strong { color: #fecaca; }

        /* ─── Data Source Footer ─── */
        .ds-footer { margin: 0; padding: 0.5rem 2rem; background: #0f172a; border-top: 1px solid #1e293b; }
        .ds-footer-toggle {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(30,41,59,0.6); border: 1px solid #334155; border-radius: 8px;
            padding: 0.6rem 1rem; cursor: pointer; width: 100%; color: #94a3b8; font-size: 0.8rem;
            transition: background 0.2s;
        }
        .ds-footer-toggle:hover { background: rgba(30,41,59,0.9); }
        .ds-footer-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; font-size: 0.78rem; }
        .ds-footer-table th { text-align: left; color: #64748b; padding: 0.4rem 0.6rem; border-bottom: 1px solid #1e293b; font-weight: 500; }
        .ds-footer-table td { padding: 0.4rem 0.6rem; color: #cbd5e1; border-bottom: 1px solid rgba(30,41,59,0.5); }
        .ds-footer-table tr:hover td { background: rgba(51,65,85,0.3); }
        .ds-status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
        .ds-badge { display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 0.68rem; font-weight: 600; }
        .ds-badge-auto { background: rgba(34,197,94,0.15); color: #22c55e; }
        .ds-badge-manual { background: rgba(100,116,139,0.2); color: #94a3b8; }
        .ds-badge-static { background: rgba(100,116,139,0.2); color: #64748b; }
        .ds-badge-ondemand { background: rgba(139,92,246,0.15); color: #a78bfa; }
        .ds-detail-row td { padding: 0.3rem 0.6rem 0.5rem; color: #64748b; font-size: 0.72rem; border-bottom: 1px solid rgba(30,41,59,0.3); }
        .ds-detail-row a { color: #60a5fa; text-decoration: none; }
        .ds-detail-row a:hover { text-decoration: underline; }

        /* Responsive */
        @media (max-width: 900px) {
            .main { flex-direction: column; }
            .signal-feed { width: 100%; min-width: unset; max-height: 40vh; border-right: none; border-bottom: 1px solid #334155; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <a href="index.html">← Dashboard</a>
        <h1>Intelligence Board</h1>
        <span class="badge badge-blue">Signal Engine v1.0</span>
        <button class="btn" onclick="generateSignals()">Generate Signals</button>
        <button class="btn" onclick="loadSignals()">Refresh</button>
    </div>

    <div class="purpose-bar">
        <span class="purpose-title">Purpose</span>
        <span class="purpose-desc">교차 데이터 시그널을 빠르게 검토해 실제 투자 아이디어로 전환하는 전략가 데스크입니다.</span>
    </div>

    <div id="demoBanner" class="demo-banner" style="display:none;">
        <strong>DEMO</strong> <span id="demoCount">0</span>건의 DEMO 데이터가 포함되어 있습니다
    </div>

    <div class="main">
        <!-- Signal Feed (Left 35%) -->
        <div class="signal-feed">
            <div class="feed-header">
                <h2>Signal Feed</h2>
                <div class="feed-controls">
                    <select id="filterStatus" onchange="loadSignals()">
                        <option value="">All Status</option>
                        <option value="new,reviewed" selected>New + Reviewed (Recommended)</option>
                        <option value="new">New only</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <select id="filterCategory" onchange="loadSignals()">
                        <option value="">All Category</option>
                        <option value="RISK">RISK</option>
                        <option value="SECTOR">SECTOR</option>
                        <option value="PORTFOLIO">PORTFOLIO</option>
                        <option value="THEME">THEME</option>
                    </select>
                    <select id="filterConfidence" onchange="loadSignals()">
                        <option value="">All Confidence</option>
                        <option value="0.8">>= 80%</option>
                        <option value="0.6">>= 60%</option>
                        <option value="0.4">>= 40%</option>
                    </select>
                    <select id="sortBy" onchange="loadSignals()">
                        <option value="created_desc" selected>Newest</option>
                        <option value="confidence_desc">Highest Confidence</option>
                    </select>
                    <input id="filterSearch" type="text" placeholder="Search title/action..." oninput="debouncedLoadSignals()">
                </div>
            </div>
            <div class="generate-bar">
                <span class="status" id="genStatus">Ready — Click "Generate Signals" to detect cross-data patterns</span>
                <span class="summary" id="feedSummary">0 signals</span>
            </div>
            <div class="feed-list" id="feedList">
                <div class="loading">Load signals or generate new ones</div>
            </div>
        </div>

        <!-- Detail Panel (Right 65%) -->
        <div class="detail-panel" id="detailPanel">
            <div class="detail-empty">
                Select a signal from the feed to view details
            </div>
        </div>
    </div>

    <!-- Data Source Footer -->
    <div class="ds-footer" id="dsFooter"></div>

    <script>
    const API = 'http://localhost:8000';
    let signals = [];
    let rawSignals = [];
    let selectedSignalId = null;
    let loadSignalsTimer = null;
    let actionInFlight = false;

    // ─── Data Source Footer ───
    const DATA_SOURCES = [
        { name: "Daily Work (Excel)", db_table: "daily_work", collector_key: null, type: "manual", script: "scripts/idea_pipeline/ingest.py" },
        { name: "AI Insights", db_table: "insights", collector_key: null, type: "on-demand" },
        { name: "Investment Ideas", db_table: "ideas", collector_key: null, type: "manual" },
        { name: "Sector Momentum", db_table: null, collector_key: null, type: "on-demand", script: "scripts/idea_pipeline/sector_momentum.py" },
        { name: "Market Events", db_table: null, collector_key: null, type: "static", script: "data/market_events.json" },
    ];

    function renderDSFooter() {
        let dsExpanded = false;
        let dsDetailIdx = null;
        let dsStatus = null;

        fetch(API + '/api/v1/collector/status').then(r => r.json()).then(d => { dsStatus = d; draw(); }).catch(() => draw());

        function getStatusColor(src) {
            if (!src.collector_key || !dsStatus?.collectors?.[src.collector_key]) {
                const m = { manual: '#64748b', static: '#64748b', 'on-demand': '#8b5cf6' };
                return m[src.type] || '#475569';
            }
            const c = dsStatus.collectors[src.collector_key];
            if (!c || c.status !== 'success') return '#ef4444';
            const hours = (Date.now() - new Date(c.created_at).getTime()) / 3600000;
            return hours < 1 ? '#22c55e' : hours < 24 ? '#eab308' : '#ef4444';
        }

        function getLastTime(src) {
            if (!src.collector_key || !dsStatus?.collectors?.[src.collector_key]) return '-';
            const c = dsStatus.collectors[src.collector_key];
            if (!c?.created_at) return '-';
            return new Date(c.created_at).toLocaleString('ko-KR', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
        }

        function getCount(src) {
            if (!src.db_table || !dsStatus?.table_counts) return '-';
            const cnt = dsStatus.table_counts[src.db_table];
            return cnt != null ? cnt.toLocaleString() : '-';
        }

        function typeBadge(type) {
            const labels = { auto: '자동', manual: '수동', static: '정적', 'on-demand': '요청시' };
            const cls = type === 'on-demand' ? 'ondemand' : type;
            return `<span class="ds-badge ds-badge-${cls}">${labels[type] || type}</span>`;
        }

        function draw() {
            const el = document.getElementById('dsFooter');
            const latestTime = DATA_SOURCES
                .map(s => s.collector_key && dsStatus?.collectors?.[s.collector_key]?.created_at)
                .filter(Boolean).sort().pop();
            const latestStr = latestTime ? ` &middot; 마지막 수집 ${new Date(latestTime).toLocaleString('ko-KR', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' })}` : '';

            let html = `<button class="ds-footer-toggle" id="dsToggle">
                <span>${dsExpanded ? '\u25BE' : '\u25B8'} 데이터 소스 (${DATA_SOURCES.length}개${latestStr})</span>
                <span style="font-size:0.72rem">${dsExpanded ? '접기' : '펼치기'}</span>
            </button>`;

            if (dsExpanded) {
                html += `<table class="ds-footer-table"><thead><tr>
                    <th>소스</th><th>DB 테이블</th><th>건수</th><th>마지막 수집</th><th>유형</th><th>상태</th>
                </tr></thead><tbody>`;
                DATA_SOURCES.forEach((src, i) => {
                    html += `<tr class="ds-row" data-idx="${i}" style="cursor:pointer">
                        <td>${src.name}</td>
                        <td><code style="font-size:0.72rem;color:#94a3b8">${src.db_table || '-'}</code></td>
                        <td>${getCount(src)}</td>
                        <td>${getLastTime(src)}</td>
                        <td>${typeBadge(src.type)}</td>
                        <td><span class="ds-status-dot" style="background:${getStatusColor(src)}"></span></td>
                    </tr>`;
                    if (dsDetailIdx === i) {
                        html += `<tr class="ds-detail-row"><td colspan="6">`;
                        if (src.api_url) html += `<div>API: <a href="${src.api_url}" target="_blank" rel="noopener noreferrer">${src.api_url}</a></div>`;
                        if (src.script) html += `<div>Script: <code>${src.script}</code></div>`;
                        html += `</td></tr>`;
                    }
                });
                html += `</tbody></table>`;
            }
            el.innerHTML = html;

            document.getElementById('dsToggle').addEventListener('click', () => { dsExpanded = !dsExpanded; draw(); });
            el.querySelectorAll('.ds-row').forEach(row => {
                row.addEventListener('click', () => {
                    const idx = parseInt(row.dataset.idx);
                    dsDetailIdx = dsDetailIdx === idx ? null : idx;
                    draw();
                });
            });
        }
        draw();
    }

    function toFiniteNumber(value, fallback = 0) {
        const n = Number(value);
        return Number.isFinite(n) ? n : fallback;
    }

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function safeUrl(url) {
        if (!url) return '';
        try {
            const parsed = new URL(String(url));
            return ['http:', 'https:'].includes(parsed.protocol) ? parsed.toString() : '';
        } catch (_) {
            return '';
        }
    }

    function setActionButtonsDisabled(disabled) {
        document.querySelectorAll('.action-bar .btn').forEach((btn) => {
            btn.disabled = disabled;
        });
    }

    function debouncedLoadSignals() {
        if (loadSignalsTimer) {
            clearTimeout(loadSignalsTimer);
        }
        loadSignalsTimer = setTimeout(() => {
            loadSignals();
        }, 250);
    }

    async function fetchJSON(url, options = {}, timeoutMs = 12000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

        try {
            const response = await fetch(url, { ...options, signal: controller.signal });
            const raw = await response.text();
            let data = {};

            if (raw) {
                try {
                    data = JSON.parse(raw);
                } catch (_) {
                    data = { detail: raw };
                }
            }

            if (!response.ok) {
                const detail = typeof data.detail === 'string'
                    ? data.detail
                    : `${response.status} ${response.statusText}`;
                throw new Error(detail);
            }
            return data;
        } finally {
            clearTimeout(timeoutId);
        }
    }

    // ─── Confidence Color ───
    function confColor(c) {
        if (c >= 0.8) return '#ef4444';
        if (c >= 0.6) return '#f59e0b';
        if (c >= 0.4) return '#94a3b8';
        return '#64748b';
    }
    function confLabel(c) {
        if (c >= 0.8) return 'HIGH';
        if (c >= 0.6) return 'MED';
        if (c >= 0.4) return 'LOW';
        return 'WEAK';
    }
    function categoryBadgeClass(cat) {
        const map = { RISK: 'badge-red', SECTOR: 'badge-blue', PORTFOLIO: 'badge-purple', THEME: 'badge-green' };
        return map[cat] || 'badge-gray';
    }

    // ─── Time Ago ───
    function timeAgo(isoStr) {
        if (!isoStr) return '';
        const d = new Date(isoStr);
        const diff = (Date.now() - d.getTime()) / 1000;
        if (diff < 60) return 'just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'min ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return Math.floor(diff / 86400) + 'd ago';
    }

    // ─── DEMO check ───
    function isDemo(source) {
        return source && (source === 'DEMO' || source.startsWith('[DEMO]'));
    }

    // ─── Generate Signals ───
    async function generateSignals() {
        const genStatus = document.getElementById('genStatus');
        genStatus.textContent = 'Generating signals...';
        try {
            const data = await fetchJSON(API + '/api/v1/signals/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days: 3 }),
            });
            genStatus.textContent = `Generated ${toFiniteNumber(data.signals_count)} signals at ${new Date().toLocaleTimeString()}`;
            await loadSignals();
        } catch (e) {
            genStatus.textContent = 'Error: ' + e.message;
        }
    }

    // ─── Load Signals ───
    async function loadSignals() {
        const feedList = document.getElementById('feedList');
        const feedSummary = document.getElementById('feedSummary');
        feedList.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        const status = document.getElementById('filterStatus').value;
        const category = document.getElementById('filterCategory').value;
        const minConfidenceRaw = document.getElementById('filterConfidence').value;
        const sortBy = document.getElementById('sortBy').value;
        const searchKeyword = document.getElementById('filterSearch').value.trim().toLowerCase();

        const params = new URLSearchParams();
        params.set('limit', '100');
        if (status) params.set('status', status);
        if (category) params.set('category', category);
        if (minConfidenceRaw !== '') params.set('min_confidence', minConfidenceRaw);

        try {
            const data = await fetchJSON(`${API}/api/v1/signals?${params.toString()}`);
            rawSignals = Array.isArray(data.signals) ? data.signals : [];
            const total = toFiniteNumber(data.total, rawSignals.length);
            const minConfidence = minConfidenceRaw === '' ? null : toFiniteNumber(minConfidenceRaw);

            signals = rawSignals.filter((s) => {
                const confidence = toFiniteNumber(s.confidence);
                const haystack = `${s.title || ''} ${s.description || ''} ${s.suggested_action || ''}`.toLowerCase();
                const searchMatch = !searchKeyword || haystack.includes(searchKeyword);
                const confidenceMatch = minConfidence === null || confidence >= minConfidence;
                return searchMatch && confidenceMatch;
            });

            if (sortBy === 'confidence_desc') {
                signals.sort((a, b) => {
                    const confidenceDiff = toFiniteNumber(b.confidence) - toFiniteNumber(a.confidence);
                    if (confidenceDiff !== 0) return confidenceDiff;
                    return new Date(b.created_at || 0).getTime() - new Date(a.created_at || 0).getTime();
                });
            } else {
                signals.sort((a, b) => new Date(b.created_at || 0).getTime() - new Date(a.created_at || 0).getTime());
            }

            feedSummary.textContent = `${signals.length} shown / ${total} total`;

            if (signals.length === 0) {
                feedList.innerHTML = '<div class="loading">No signals found for current filters.</div>';
                selectedSignalId = null;
                document.getElementById('detailPanel').innerHTML = '<div class="detail-empty">Select a signal from the feed to view details</div>';
                return;
            }

            feedList.innerHTML = signals.map((s) => renderSignalCard(s)).join('');

            // Reselect if still valid
            if (selectedSignalId && signals.find((s) => s.id === selectedSignalId)) {
                document.querySelector(`.signal-card[data-id="${selectedSignalId}"]`)?.classList.add('active');
            }
        } catch (e) {
            feedSummary.textContent = '0 signals';
            feedList.innerHTML = '<div class="loading">API connection error: ' + escapeHtml(e.message) + '</div>';
        }
    }

    // ─── Render Signal Card ───
    function renderSignalCard(s) {
        const signalId = toFiniteNumber(s.id, -1);
        if (signalId < 0) return '';

        const confidence = toFiniteNumber(s.confidence);
        const color = confColor(confidence);
        const catClass = categoryBadgeClass(s.category);
        const sources = escapeHtml((s.data_sources || []).join(' + '));
        const gaps = (s.data_gaps || []).length;
        const isActive = signalId === selectedSignalId ? ' active' : '';
        const title = escapeHtml(s.title);
        const action = escapeHtml(s.suggested_action || '');
        const status = escapeHtml(s.status || 'new');
        const category = escapeHtml(s.category || 'UNKNOWN');

        return `<div class="signal-card${isActive}" data-id="${signalId}" onclick="selectSignal(${signalId})">
            <div class="signal-card-top">
                <span class="conf-dot" style="background:${color}"></span>
                <span class="conf-text" style="color:${color}">${Math.round(confidence * 100)}%</span>
                <span class="signal-card-title">${title}</span>
            </div>
            <div class="signal-card-meta">
                <span class="badge ${catClass}">${category}</span>
                <span>${sources}</span>
            </div>
            <div class="signal-card-action">${action}</div>
            <div class="signal-card-bottom">
                <span>${timeAgo(s.created_at)}</span>
                <span class="badge badge-gray">${status}</span>
                ${gaps > 0 ? `<span class="gap-warn">⚠ gaps: ${gaps}</span>` : ''}
            </div>
        </div>`;
    }

    // ─── Select Signal ───
    async function selectSignal(id) {
        selectedSignalId = toFiniteNumber(id, -1);
        if (selectedSignalId < 0) return;

        // Update active card
        document.querySelectorAll('.signal-card').forEach(c => c.classList.remove('active'));
        document.querySelector(`.signal-card[data-id="${selectedSignalId}"]`)?.classList.add('active');

        const panel = document.getElementById('detailPanel');
        panel.innerHTML = '<div class="loading"><div class="spinner"></div> Loading...</div>';

        try {
            // Fetch signal detail + gaps in parallel
            const [signal, gapData] = await Promise.all([
                fetchJSON(API + '/api/v1/signals/' + selectedSignalId),
                fetchJSON(API + '/api/v1/signals/' + selectedSignalId + '/gaps'),
            ]);
            renderDetailPanel(signal, gapData.gaps || {});
        } catch (e) {
            panel.innerHTML = '<div class="loading">Error: ' + escapeHtml(e.message) + '</div>';
        }
    }

    // ─── Render Detail Panel ───
    function renderDetailPanel(s, gapResult) {
        const panel = document.getElementById('detailPanel');
        const signalId = toFiniteNumber(s.id, -1);
        const confidence = toFiniteNumber(s.confidence);
        const pct = Math.max(0, Math.min(100, Math.round(confidence * 100)));
        const color = confColor(confidence);
        const statusValue = String(s.status || 'new');
        const isTerminal = statusValue === 'accepted' || statusValue === 'rejected';

        // Parse AI interpretation
        let aiData = null;
        if (s.ai_interpretation) {
            try { aiData = JSON.parse(s.ai_interpretation); } catch(e) { aiData = { interpretation: s.ai_interpretation }; }
        }

        const gaps = gapResult.gaps || [];
        const recs = gapResult.recommendations || [];
        const enrichments = gapResult.enrichments || [];

        panel.innerHTML = `
        <div class="detail-content">
            <!-- Header -->
            <div class="detail-header">
                <h2>${escapeHtml(s.title)}</h2>
                <p>${escapeHtml(s.description || '')}</p>
                <div class="detail-conf">
                    <span class="badge ${categoryBadgeClass(s.category)}">${escapeHtml(s.category || 'UNKNOWN')}</span>
                    <span class="badge badge-gray">${escapeHtml(s.signal_type || 'cross')}</span>
                    <span class="badge badge-gray">${escapeHtml(statusValue)}</span>
                    <span style="color:${color}; font-weight:700; font-size:0.9rem;">${pct}% ${confLabel(confidence)}</span>
                    <div class="conf-bar-bg">
                        <div class="conf-bar" style="width:${pct}%; background:${color};"></div>
                    </div>
                </div>
            </div>

            <!-- Evidence Section -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <span style="color:#3b82f6;">■</span> Evidence Data
                </div>
                <div class="detail-section-body">
                    ${(s.evidence || []).map((e) => `
                        <div class="evidence-item">
                            <span class="evidence-module">${escapeHtml(e.module)}</span>
                            <span class="evidence-label">${escapeHtml(e.label)}</span>
                            <span class="evidence-value">${escapeHtml(formatValue(e.value))}</span>
                        </div>
                    `).join('') || '<span class="ai-unavailable">No evidence data</span>'}
                </div>
            </div>

            <!-- AI Strategist Interpretation -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <span style="color:#a855f7;">■</span> AI Strategist Interpretation
                    ${!aiData ? `<button class="btn btn-primary" style="margin-left:auto; font-size:0.7rem;" onclick="requestAI(${signalId}, this)">Request AI Analysis</button>` : ''}
                </div>
                <div class="detail-section-body">
                    ${aiData ? renderAISection(aiData) : '<span class="ai-unavailable">AI 해석 미요청. 버튼을 클릭하여 분석을 요청하세요.</span>'}
                </div>
            </div>

            <!-- Data Gaps & Recommendations -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <span style="color:#f59e0b;">■</span> Data Gaps & External Source Recommendations
                    <span class="badge badge-amber" style="margin-left:auto;">${gaps.length} gaps</span>
                </div>
                <div class="detail-section-body">
                    ${gaps.length > 0 ? gaps.map((g) => `
                        <div class="gap-item">
                            <div class="gap-module">⚠ ${escapeHtml(g.module)}</div>
                            <div class="gap-reason">${escapeHtml(g.reason)}</div>
                            <div class="gap-impact">${escapeHtml(g.impact || '')}</div>
                        </div>
                    `).join('') : '<span style="color:#22c55e; font-size:0.85rem;">All data sources available</span>'}

                    ${recs.length > 0 ? `
                        <div style="margin-top:1rem; font-size:0.75rem; color:#94a3b8; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Recommended External Sources</div>
                        ${recs.map((r) => {
                            const sourceUrl = safeUrl(r.url);
                            return `
                            <div class="rec-item">
                                <div class="rec-name">${escapeHtml(r.name)}</div>
                                <div class="rec-synergy">${escapeHtml(r.synergy)}</div>
                                <div class="rec-boost">Confidence boost: ${escapeHtml(r.confidence_boost)}</div>
                                ${sourceUrl ? `<div class="rec-url"><a href="${sourceUrl}" target="_blank" rel="noopener noreferrer">→ ${escapeHtml(sourceUrl)}</a></div>` : ''}
                            </div>`;
                        }).join('')}
                    ` : ''}

                    ${enrichments.length > 0 ? `
                        <div style="margin-top:1rem; font-size:0.75rem; color:#94a3b8; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Enrichment Sources</div>
                        ${enrichments.map((e) => `
                            <div class="rec-item">
                                <div class="rec-name">${escapeHtml(e.name)}</div>
                                <div class="rec-synergy">${escapeHtml(e.synergy)}</div>
                                <div class="rec-boost">${escapeHtml(e.benefit)}</div>
                            </div>
                        `).join('')}
                    ` : ''}
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                ${!isTerminal ? `
                    <button class="btn btn-success" onclick="acceptSignal(${signalId})">✓ Accept → Create Idea</button>
                    <button class="btn" onclick="updateStatus(${signalId}, 'reviewed')">Mark Reviewed</button>
                    <button class="btn btn-danger" onclick="updateStatus(${signalId}, 'rejected')">✕ Reject</button>
                ` : `
                    <span class="badge ${statusValue === 'accepted' ? 'badge-green' : 'badge-red'}" style="font-size:0.85rem; padding:6px 14px;">
                        ${statusValue === 'accepted' ? '✓ Accepted' : '✕ Rejected'}
                    </span>
                    ${s.related_idea_id ? `<span style="font-size:0.8rem; color:#94a3b8;">→ Idea #${escapeHtml(s.related_idea_id)}</span>` : ''}
                `}
                <span style="flex:1;"></span>
                <span style="font-size:0.7rem; color:#475569;">Signal ID: ${escapeHtml(s.signal_id || String(signalId))}</span>
            </div>
        </div>`;
    }

    function formatValue(v) {
        if (v === null || v === undefined) return 'N/A';
        if (typeof v === 'number') return v.toFixed ? v.toFixed(2) : String(v);
        if (typeof v === 'boolean') return v ? 'Yes' : 'No';
        return String(v);
    }

    function renderAISection(ai) {
        let html = '';
        if (ai.interpretation) {
            html += `<div class="ai-text">${escapeHtml(ai.interpretation)}</div>`;
        }
        if (ai.hypothesis) {
            html += `<div class="ai-hypothesis">${escapeHtml(ai.hypothesis)}</div>`;
        }
        if (ai.actions && ai.actions.length > 0) {
            html += '<ul class="ai-actions">';
            ai.actions.forEach((a) => { html += `<li>${escapeHtml(a)}</li>`; });
            html += '</ul>';
        }
        if (ai.risk_factors && ai.risk_factors.length > 0) {
            html += '<div style="margin-top:0.5rem; font-size:0.75rem; color:#94a3b8;">Risk Factors:</div><ul class="ai-actions">';
            ai.risk_factors.forEach((r) => { html += `<li style="color:#fbbf24;">${escapeHtml(r)}</li>`; });
            html += '</ul>';
        }
        const adjustment = Number(ai.confidence_adjustment);
        if (Number.isFinite(adjustment) && adjustment !== 0) {
            const adj = adjustment > 0 ? '+' : '';
            html += `<div style="margin-top:0.5rem; font-size:0.75rem; color:#94a3b8;">AI Confidence Adjustment: <span style="color:${adjustment > 0 ? '#22c55e' : '#ef4444'}">${adj}${(adjustment * 100).toFixed(0)}%</span></div>`;
        }
        if (ai.reason) {
            html += `<div class="ai-unavailable">${escapeHtml(ai.reason)}</div>`;
        }
        return html || '<span class="ai-unavailable">No interpretation available</span>';
    }

    // ─── Actions ───
    async function requestAI(id, btn) {
        if (actionInFlight) return;
        actionInFlight = true;
        setActionButtonsDisabled(true);
        if (btn) btn.textContent = 'Analyzing...';

        try {
            await fetchJSON(API + '/api/v1/signals/' + id + '/interpret', { method: 'POST' });
            await loadSignals();
            await selectSignal(id);
        } catch (e) {
            alert('AI analysis error: ' + e.message);
        } finally {
            actionInFlight = false;
            setActionButtonsDisabled(false);
        }
    }

    async function acceptSignal(id) {
        if (actionInFlight) return;
        actionInFlight = true;
        setActionButtonsDisabled(true);

        try {
            const data = await fetchJSON(API + '/api/v1/signals/' + id + '/accept', { method: 'POST' });
            if (data.idea) {
                alert(`Idea created: #${data.idea.id} — ${data.idea.title}`);
            }
            await loadSignals();
            if (signals.find((s) => s.id === id)) {
                await selectSignal(id);
            }
        } catch (e) {
            alert('Accept error: ' + e.message);
        } finally {
            actionInFlight = false;
            setActionButtonsDisabled(false);
        }
    }

    async function updateStatus(id, status) {
        if (actionInFlight) return;
        actionInFlight = true;
        setActionButtonsDisabled(true);

        try {
            await fetchJSON(API + '/api/v1/signals/' + id + '/status', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status }),
            });
            await loadSignals();
            if (signals.find((s) => s.id === id)) {
                await selectSignal(id);
            }
        } catch (e) {
            alert('Status update error: ' + e.message);
        } finally {
            actionInFlight = false;
            setActionButtonsDisabled(false);
        }
    }

    // ─── Init ───
    loadSignals();
    renderDSFooter();
    </script>
</body>
</html>
