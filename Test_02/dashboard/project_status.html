<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>프로젝트 개발현황</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #020617;
            --panel: rgba(15, 23, 42, 0.88);
            --panel-soft: rgba(30, 41, 59, 0.6);
            --border: #334155;
            --text: #f8fafc;
            --muted: #94a3b8;
            --accent: #22c55e;
            --warn: #f59e0b;
            --idle: #60a5fa;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: radial-gradient(circle at top right, rgba(34, 197, 94, 0.12), transparent 40%), var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1380px;
            margin: 0 auto;
            padding: 1.25rem 1rem 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .title-wrap h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .title-wrap p {
            margin: 0.4rem 0 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .link-back {
            color: #cbd5e1;
            text-decoration: none;
            border: 1px solid var(--border);
            background: var(--panel-soft);
            border-radius: 10px;
            padding: 0.55rem 0.8rem;
            font-size: 0.85rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .summary-item {
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--panel);
            padding: 0.75rem;
        }

        .summary-label {
            color: var(--muted);
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
            display: block;
        }

        .summary-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .progress-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #21262d;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #238636, #2ea043);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.82rem;
            font-weight: 600;
            color: #e2e8f0;
            white-space: nowrap;
        }

        .filter-tabs {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 0.35rem 0.7rem;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--muted);
            font-size: 0.76rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .filter-tab:hover {
            border-color: #475569;
            color: var(--text);
        }

        .filter-tab.is-active {
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.4);
            color: var(--accent);
        }

        .layout {
            display: grid;
            grid-template-columns: 1.15fr 1fr;
            gap: 1rem;
        }

        .card {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--panel);
            padding: 1rem;
        }

        .card h2 {
            margin: 0 0 0.9rem;
            font-size: 1rem;
        }

        .dev-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .dev-row {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--panel-soft);
            color: var(--text);
            text-align: left;
            padding: 0.75rem;
            cursor: pointer;
        }

        .dev-row.is-active {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3) inset;
            background: rgba(34, 197, 94, 0.1);
        }

        .dev-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .dev-title {
            font-size: 0.87rem;
            font-weight: 700;
        }

        .dev-meta {
            margin-top: 0.35rem;
            color: var(--muted);
            font-size: 0.76rem;
        }

        .badge {
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 0.72rem;
            padding: 0.1rem 0.5rem;
            font-weight: 700;
        }

        .badge-complete {
            color: var(--accent);
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.35);
        }

        .badge-progress {
            color: var(--warn);
            background: rgba(245, 158, 11, 0.12);
            border-color: rgba(245, 158, 11, 0.35);
        }

        .badge-pending {
            color: var(--idle);
            background: rgba(96, 165, 250, 0.12);
            border-color: rgba(96, 165, 250, 0.35);
        }

        .badge-check {
            color: #facc15;
            background: rgba(250, 204, 21, 0.12);
            border-color: rgba(250, 204, 21, 0.35);
        }

        .badge-design {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.12);
            border-color: rgba(96, 165, 250, 0.35);
        }

        .source-badge {
            font-size: 0.6rem;
            font-weight: 700;
            padding: 0.06rem 0.3rem;
            border-radius: 4px;
            margin-right: 0.3rem;
            vertical-align: middle;
        }
        .source-badge-req {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.3);
        }
        .source-badge-pdca {
            color: #a78bfa;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            position: sticky;
            top: 1.25rem;
            max-height: calc(100vh - 10rem);
            overflow-y: auto;
            align-self: start;
        }

        .meta-line {
            color: #cbd5e1;
            font-size: 0.8rem;
            margin-bottom: 0.35rem;
        }

        .meta-label {
            color: var(--muted);
        }

        .list-plain {
            margin: 0;
            padding-left: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
            font-size: 0.82rem;
        }

        .list-plain code {
            color: #93c5fd;
        }

        .list-plain li:hover {
            background: rgba(96, 165, 250, 0.08);
            border-radius: 4px;
            padding: 0.15rem 0.3rem;
            margin: -0.15rem -0.3rem;
        }

        .check-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 1px solid #1e293b;
            padding: 0.36rem 0;
            font-size: 0.82rem;
        }

        .check-row:last-child {
            border-bottom: none;
        }

        .check-mark-ok {
            color: var(--accent);
            font-weight: 700;
        }

        .check-mark-pending {
            color: var(--muted);
            font-weight: 700;
        }

        .check-empty {
            color: var(--muted);
            font-size: 0.82rem;
            font-style: italic;
            padding: 0.5rem 0;
        }

        .check-label-done {
            text-decoration: line-through;
            color: var(--muted);
        }

        .check-doc-link {
            color: #60a5fa;
            text-decoration: none;
            font-size: 0.72rem;
            opacity: 0.7;
            transition: opacity 0.15s;
        }

        .check-doc-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .check-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feature-desc {
            color: var(--muted);
            font-size: 0.78rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            border-left: 2px solid #334155;
            padding-left: 0.5rem;
        }

        .doc-badges {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }
        .doc-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.72rem;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }
        .doc-badge:hover { transform: translateY(-1px); }
        .doc-badge-plan { background: rgba(96,165,250,0.15); color: #60a5fa; border-color: rgba(96,165,250,0.3); }
        .doc-badge-design { background: rgba(168,85,247,0.15); color: #a855f7; border-color: rgba(168,85,247,0.3); }
        .doc-badge-analysis { background: rgba(34,197,94,0.15); color: #22c55e; border-color: rgba(34,197,94,0.3); }
        .doc-badge-report { background: rgba(249,115,22,0.15); color: #f97316; border-color: rgba(249,115,22,0.3); }

        /* Document modal */
        .doc-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        .doc-modal-overlay.open { display: flex; }
        .doc-modal {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            width: 100%;
            max-width: 860px;
            max-height: 82vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .doc-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #1e293b;
            flex-shrink: 0;
        }
        .doc-modal-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        .doc-modal-path {
            font-size: 0.7rem;
            color: #64748b;
            margin-left: 0.75rem;
        }
        .doc-modal-close {
            background: none;
            border: 1px solid #334155;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 4px;
            padding: 0.25rem 0.6rem;
            font-size: 0.8rem;
        }
        .doc-modal-close:hover { background: #1e293b; color: #f8fafc; }
        .doc-modal-body {
            padding: 1rem 1.25rem;
            overflow-y: auto;
            flex: 1;
        }
        .doc-modal-body pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.78rem;
            line-height: 1.6;
            color: #cbd5e1;
        }
        .doc-modal-loading {
            text-align: center;
            color: #64748b;
            padding: 3rem;
        }

        .next-action {
            margin-top: 0.65rem;
            padding-top: 0.6rem;
            border-top: 1px solid #1e293b;
            font-size: 0.8rem;
            color: #93c5fd;
        }

        @media (max-width: 980px) {
            .summary-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .layout {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                position: static;
                max-height: none;
                overflow-y: visible;
            }
        }
    </style>
</head>

<body data-testid="project-status-page">
    <div class="container">
        <div class="header">
            <div class="title-wrap">
                <h1>개발현황</h1>
                <p>개발리스트와 상태(완료, 개발중, 미착수)를 기준으로 상세 프로그램/체크리스트를 확인합니다.</p>
            </div>
            <a class="link-back" href="index.html">메인 대시보드로</a>
        </div>

        <section class="summary-grid">
            <article class="summary-item"><span class="summary-label">전체</span><span class="summary-value"
                    data-testid="project-status-count-total">0</span></article>
            <article class="summary-item"><span class="summary-label">완료</span><span class="summary-value"
                    data-testid="project-status-count-completed">0</span></article>
            <article class="summary-item"><span class="summary-label">개발중</span><span class="summary-value"
                    data-testid="project-status-count-in-progress">0</span></article>
            <article class="summary-item"><span class="summary-label">미착수</span><span class="summary-value"
                    data-testid="project-status-count-pending">0</span></article>
        </section>

        <section class="progress-section" id="progress-section">
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <span class="progress-text" id="progress-text">0%</span>
        </section>

        <nav class="filter-tabs" id="filter-tabs"></nav>

        <section class="layout">
            <article class="card">
                <h2 style="display:flex;align-items:center;gap:0.5rem;">개발 리스트 | 상태
                    <span style="margin-left:auto;display:flex;gap:4px;">
                        <button type="button" id="sort-asc" title="번호 오름차순" style="background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:2px 8px;font-size:0.75rem;cursor:pointer;">▲</button>
                        <button type="button" id="sort-desc" title="번호 내림차순" style="background:none;border:1px solid var(--border);color:var(--muted);border-radius:6px;padding:2px 8px;font-size:0.75rem;cursor:pointer;">▼</button>
                    </span>
                </h2>
                <div class="dev-list" id="dev-list"></div>
            </article>

            <div class="detail-grid">
                <article class="card">
                    <h2 id="detail-title" data-testid="project-status-program-title">상세 개발 프로그램</h2>
                    <div class="meta-line"><span class="meta-label">요청 ID:</span> <span
                            data-testid="project-status-selected-id">-</span></div>
                    <div class="meta-line" id="doc-links-row" style="display:none"><span class="meta-label">문서:</span> <span class="doc-badges" id="doc-badges"></span></div>
                    <div class="meta-line"><span class="meta-label">진행 단계:</span> <span id="detail-stage">-</span></div>
                    <div class="meta-line"><span class="meta-label">담당:</span> <span id="detail-owner">-</span></div>
                    <div class="meta-line"><span class="meta-label">기한:</span> <span id="detail-due">-</span></div>
                    <ol class="list-plain" id="program-list" data-testid="project-status-program-list"></ol>
                </article>

                <article class="card">
                    <h2>체크리스트 요약</h2>
                    <div class="feature-desc" id="feature-desc" style="display:none"></div>
                    <div id="checklist" data-testid="project-status-checklist-list"></div>
                    <div class="next-action" id="next-action" data-testid="project-status-next-action"></div>
                </article>
            </div>
        </section>
    </div>

    <!-- Document viewer modal -->
    <div class="doc-modal-overlay" id="doc-modal-overlay">
        <div class="doc-modal">
            <div class="doc-modal-header">
                <div>
                    <span class="doc-modal-title" id="doc-modal-title">Document</span>
                    <span class="doc-modal-path" id="doc-modal-path"></span>
                </div>
                <button class="doc-modal-close" id="doc-modal-close">ESC</button>
            </div>
            <div class="doc-modal-body" id="doc-modal-body">
                <div class="doc-modal-loading">Loading...</div>
            </div>
        </div>
    </div>

    <script src="js/project_status_data.js"></script>
    <script>
        const rawItems = Array.isArray(window.PROJECT_STATUS_ITEMS) ? window.PROJECT_STATUS_ITEMS : [];
        const items = rawItems.map((item) => ({
            ...item,
            status: item.status === '진행' ? '개발중' : item.status
        }));

        const state = {
            selectedId: null,
            filter: '개발중',
            sortDir: 'desc'
        };

        // --- Document modal ---
        const docModal = {
            overlay: document.getElementById('doc-modal-overlay'),
            title: document.getElementById('doc-modal-title'),
            path: document.getElementById('doc-modal-path'),
            body: document.getElementById('doc-modal-body'),
            close: document.getElementById('doc-modal-close'),
        };

        async function openDocModal(label, path) {
            docModal.title.textContent = label;
            docModal.path.textContent = path;
            docModal.body.innerHTML = '<div class="doc-modal-loading">Loading...</div>';
            docModal.overlay.classList.add('open');

            try {
                const resp = await fetch(`http://localhost:8000/api/v1/project-status/document?path=${encodeURIComponent(path)}`);
                if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
                const data = await resp.json();
                docModal.body.innerHTML = `<pre>${escapeHtml(data.content)}</pre>`;
            } catch (err) {
                docModal.body.innerHTML = `<div class="doc-modal-loading" style="color:#ef4444">Failed: ${escapeHtml(err.message)}</div>`;
            }
        }

        function closeDocModal() {
            docModal.overlay.classList.remove('open');
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        docModal.close.addEventListener('click', closeDocModal);
        docModal.overlay.addEventListener('click', (e) => {
            if (e.target === docModal.overlay) closeDocModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDocModal();
        });

        const els = {
            list: document.getElementById('dev-list'),
            detailTitle: document.getElementById('detail-title'),
            selectedId: document.querySelector('[data-testid="project-status-selected-id"]'),
            owner: document.getElementById('detail-owner'),
            stage: document.getElementById('detail-stage'),
            due: document.getElementById('detail-due'),
            programList: document.getElementById('program-list'),
            checklist: document.getElementById('checklist'),
            featureDesc: document.getElementById('feature-desc'),
            docLinksRow: document.getElementById('doc-links-row'),
            docBadges: document.getElementById('doc-badges'),
            nextAction: document.getElementById('next-action'),
            countTotal: document.querySelector('[data-testid="project-status-count-total"]'),
            countCompleted: document.querySelector('[data-testid="project-status-count-completed"]'),
            countInProgress: document.querySelector('[data-testid="project-status-count-in-progress"]'),
            countPending: document.querySelector('[data-testid="project-status-count-pending"]'),
            progressFill: document.getElementById('progress-fill'),
            progressText: document.getElementById('progress-text'),
            filterTabs: document.getElementById('filter-tabs')
        };

        const getStatusBadgeClass = (status) => {
            if (status === '완료') return 'badge badge-complete';
            if (status === '개발중') return 'badge badge-progress';
            if (status === '검증') return 'badge badge-check';
            if (status === '설계') return 'badge badge-design';
            return 'badge badge-pending';
        };

        const getSourceBadge = (source) => {
            if (source === 'pdca') return '<span class="source-badge source-badge-pdca">PDCA</span>';
            return '<span class="source-badge source-badge-req">REQ</span>';
        };

        const findItemById = (id) => items.find((item) => item.id === id);

        const renderSummary = () => {
            const completed = items.filter((item) => item.status === '완료').length;
            const inProgress = items.filter((item) => item.status === '개발중').length;
            const planned = items.filter((item) => item.status === '기획').length;
            const pending = items.filter((item) => item.status === '미착수').length;
            els.countTotal.textContent = String(items.length);
            els.countCompleted.textContent = String(completed);
            els.countInProgress.textContent = String(inProgress);
            els.countPending.textContent = String(pending);

            const pct = items.length > 0 ? Math.round((completed / items.length) * 100) : 0;
            els.progressFill.style.width = pct + '%';
            els.progressText.textContent = pct + '% (' + completed + '/' + items.length + ' 완료)';

            const checking = items.filter((item) => item.status === '검증' || item.status === '설계').length;
            const filters = [
                { key: 'all', label: '전체 ' + items.length },
                { key: '개발중', label: '개발중 ' + inProgress },
                { key: '검증', label: '검증 ' + checking },
                { key: '기획', label: '기획 ' + planned },
                { key: '완료', label: '완료 ' + completed }
            ];
            if (pending > 0) filters.push({ key: '미착수', label: '미착수 ' + pending });
            const reqCount = items.filter(i => (i.source || 'req') === 'req').length;
            const pdcaCount = items.filter(i => i.source === 'pdca').length;
            if (pdcaCount > 0) {
                filters.push({ key: 'req-only', label: 'REQ ' + reqCount });
                filters.push({ key: 'pdca-only', label: 'PDCA ' + pdcaCount });
            }

            els.filterTabs.innerHTML = '';
            filters.forEach((f) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'filter-tab' + (state.filter === f.key ? ' is-active' : '');
                btn.textContent = f.label;
                btn.addEventListener('click', () => {
                    state.filter = f.key;
                    render();
                });
                els.filterTabs.appendChild(btn);
            });
        };

        const getIdNum = (item) => {
            const m = (item.id || '').match(/\d+/);
            return m ? parseInt(m[0], 10) : 0;
        };

        const sortItems = (arr) => {
            const dir = state.sortDir === 'asc' ? 1 : -1;
            const isAllOrStatus = state.filter === 'all' || !['req-only', 'pdca-only'].includes(state.filter);
            return [...arr].sort((a, b) => {
                // 전체/상태 탭: REQ 먼저, PDCA 나중
                if (isAllOrStatus) {
                    const srcA = (a.source || 'req') === 'req' ? 0 : 1;
                    const srcB = (b.source || 'req') === 'req' ? 0 : 1;
                    if (srcA !== srcB) return srcA - srcB;
                }
                return (getIdNum(a) - getIdNum(b)) * dir;
            });
        };

        const updateSortButtons = () => {
            const asc = document.getElementById('sort-asc');
            const desc = document.getElementById('sort-desc');
            asc.style.background = state.sortDir === 'asc' ? 'var(--panel-soft)' : 'none';
            asc.style.color = state.sortDir === 'asc' ? 'var(--accent)' : 'var(--muted)';
            desc.style.background = state.sortDir === 'desc' ? 'var(--panel-soft)' : 'none';
            desc.style.color = state.sortDir === 'desc' ? 'var(--accent)' : 'var(--muted)';
        };

        const renderList = () => {
            els.list.innerHTML = '';
            updateSortButtons();
            let filtered;
            if (state.filter === 'all') {
                filtered = items;
            } else if (state.filter === 'req-only') {
                filtered = items.filter((item) => (item.source || 'req') === 'req');
            } else if (state.filter === 'pdca-only') {
                filtered = items.filter((item) => item.source === 'pdca');
            } else if (state.filter === '검증') {
                filtered = items.filter((item) => item.status === '검증' || item.status === '설계');
            } else {
                filtered = items.filter((item) => item.status === state.filter);
            }

            filtered = sortItems(filtered);

            filtered.forEach((item) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = `dev-row${item.id === state.selectedId ? ' is-active' : ''}`;
                button.dataset.testid = `project-status-row-${item.id}`;
                button.setAttribute('data-testid', `project-status-row-${item.id}`);

                const ownerText = (item.owner && item.owner !== 'TBD' && item.owner !== '-')
                    ? ' · ' + item.owner : '';

                button.innerHTML = `
                    <div class="dev-head">
                        <span class="dev-title">${getSourceBadge(item.source || 'req')}${item.title}</span>
                        <span class="${getStatusBadgeClass(item.status)}">${item.status}</span>
                    </div>
                    <div class="dev-meta">${item.stage}${ownerText}</div>
                `;
                button.addEventListener('click', () => {
                    state.selectedId = item.id;
                    render();
                });
                els.list.appendChild(button);
            });
        };

        const autoLabel = (program) => {
            if (program.description && program.description !== 'Related file') {
                return program.description;
            }
            const ext = (program.name.split('.').pop() || '').toLowerCase();
            const labels = {
                py: 'Python script', js: 'JavaScript', jsx: 'React component',
                ts: 'TypeScript', tsx: 'React TypeScript', html: 'HTML page',
                json: 'Configuration', yml: 'CI/CD workflow', yaml: 'CI/CD workflow',
                md: 'Documentation', ps1: 'PowerShell script', bat: 'Batch script',
                txt: 'Text file', css: 'Stylesheet'
            };
            return labels[ext] || 'File';
        };

        const renderDetail = () => {
            const selected = findItemById(state.selectedId) || items[0];
            if (!selected) {
                els.detailTitle.textContent = '상세 개발 프로그램';
                els.selectedId.textContent = '-';
                els.owner.closest('.meta-line').style.display = 'none';
                els.stage.textContent = '-';
                els.due.closest('.meta-line').style.display = 'none';
                els.docLinksRow.style.display = 'none';
                els.programList.innerHTML = '';
                els.checklist.innerHTML = '';
                els.nextAction.style.display = 'none';
                return;
            }

            els.detailTitle.textContent = selected.title;
            els.selectedId.textContent = selected.id;
            els.stage.textContent = selected.stage === '진행' ? '개발중' : selected.stage;

            const ownerLine = els.owner.closest('.meta-line');
            if (selected.owner && selected.owner !== 'TBD' && selected.owner !== '-') {
                ownerLine.style.display = '';
                els.owner.textContent = selected.owner;
            } else {
                ownerLine.style.display = 'none';
            }

            const dueLine = els.due.closest('.meta-line');
            if (selected.due && selected.due !== '-') {
                dueLine.style.display = '';
                els.due.textContent = selected.due;
            } else {
                dueLine.style.display = 'none';
            }

            // Document badges
            const docs = selected.documents || {};
            const programs = selected.programs || [];
            const isReq = (selected.id || '').startsWith('REQ-');
            const badgeClass = { Plan: 'doc-badge-plan', Design: 'doc-badge-design', Analysis: 'doc-badge-analysis', Report: 'doc-badge-report' };

            // Build badge list in order: Plan → Design → Analysis → Report → Spec → sources
            const badges = [];
            // 1) PDCA-style docs (Plan/Design/Analysis/Report)
            ['Plan', 'Design', 'Analysis', 'Report'].forEach(label => {
                if (docs[label]) badges.push({ label, path: docs[label], cls: badgeClass[label] });
            });
            // 2) REQ items: add Spec badge + source file badges
            if (isReq) {
                badges.push({ label: 'Spec', path: 'REQUESTS.md', cls: 'doc-badge-plan' });
                programs.forEach(p => {
                    const ext = p.name.split('.').pop();
                    const cls = { py: 'doc-badge-analysis', js: 'doc-badge-design', jsx: 'doc-badge-design', ts: 'doc-badge-design', tsx: 'doc-badge-design', html: 'doc-badge-report', css: 'doc-badge-report' }[ext] || 'doc-badge-plan';
                    badges.push({ label: p.name, path: p.path, cls });
                });
            }

            if (badges.length > 0) {
                els.docLinksRow.style.display = '';
                els.docBadges.innerHTML = '';
                badges.forEach(({ label, path, cls }) => {
                    const span = document.createElement('span');
                    span.className = `doc-badge ${cls}`;
                    span.textContent = label;
                    span.title = path;
                    span.onclick = () => openDocModal(label, path);
                    els.docBadges.appendChild(span);
                });
            } else {
                els.docLinksRow.style.display = 'none';
            }

            els.programList.innerHTML = '';
            programs.forEach((program) => {
                const li = document.createElement('li');
                li.style.cursor = 'pointer';
                li.innerHTML = `<strong>${program.name}</strong><br /><code>${program.path}</code><br />${autoLabel(program)}`;
                li.onclick = () => openDocModal(program.name, program.path);
                els.programList.appendChild(li);
            });

            // Feature description
            if (selected.description) {
                els.featureDesc.textContent = selected.description;
                els.featureDesc.style.display = '';
            } else {
                els.featureDesc.style.display = 'none';
            }

            els.checklist.innerHTML = '';
            const checklist = selected.checklist || [];
            if (checklist.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'check-empty';
                emptyMsg.textContent = '체크리스트 미등록';
                els.checklist.appendChild(emptyMsg);
            } else {
                checklist.forEach((step) => {
                    const row = document.createElement('div');
                    row.className = 'check-row';
                    const labelClass = step.done ? 'check-label-done' : '';
                    const linkHtml = step.link
                        ? `<span class="check-doc-link" style="cursor:pointer" onclick="openDocModal('${step.label}', '${step.link}')" title="${step.link}">doc</span>`
                        : '';
                    row.innerHTML = `<span class="${labelClass}">${step.label}</span><span class="check-right">${linkHtml}<span class="${step.done ? 'check-mark-ok' : 'check-mark-pending'}">${step.done ? '완료' : '대기'}</span></span>`;
                    els.checklist.appendChild(row);
                });
            }

            if (selected.nextAction && selected.nextAction !== '-') {
                els.nextAction.style.display = '';
                els.nextAction.textContent = `다음 조치: ${selected.nextAction}`;
            } else {
                els.nextAction.style.display = 'none';
            }
        };

        const render = () => {
            renderSummary();
            renderList();
            renderDetail();
        };

        const initialize = async () => {
            // Fetch PDCA items (graceful: ignore failures)
            try {
                const resp = await fetch('http://localhost:8000/api/v1/project-status/pdca');
                const data = await resp.json();
                (data.items || []).forEach(item => {
                    items.push({
                        ...item,
                        status: item.status === '진행' ? '개발중' : item.status
                    });
                });
            } catch (e) { /* graceful: REQ만 표시 */ }

            // Fetch REQ document links from REQUESTS.md (graceful)
            try {
                const reqResp = await fetch('http://localhost:8000/api/v1/project-status/req-docs');
                const reqDocs = await reqResp.json();
                // Merge doc links into REQ items
                items.forEach(item => {
                    if ((item.id || '').startsWith('REQ-') && reqDocs[item.id]) {
                        item.documents = { ...(item.documents || {}), ...reqDocs[item.id] };
                    }
                });
            } catch (e) { /* graceful */ }

            const params = new URLSearchParams(window.location.search);
            const reqId = params.get('req');
            const filterParam = params.get('filter');
            const validFilters = ['all', '개발중', '기획', '완료', '미착수', '검증', 'req-only', 'pdca-only'];
            if (filterParam && validFilters.includes(filterParam)) {
                state.filter = filterParam;
            }
            if (reqId && findItemById(reqId)) {
                state.selectedId = reqId;
            } else if (items.length > 0) {
                const firstInProgress = items.find((item) => item.status === '개발중');
                state.selectedId = (firstInProgress || items[0]).id;
            }
            render();
        };

        document.getElementById('sort-asc').addEventListener('click', () => { state.sortDir = 'asc'; render(); });
        document.getElementById('sort-desc').addEventListener('click', () => { state.sortDir = 'desc'; render(); });

        initialize();
    </script>
</body>

</html>