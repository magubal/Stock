name: consistency-monitoring-gate

on:
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

jobs:
  consistency-monitoring-gate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install minimal dependencies for gate tests
        run: |
          python -m pip install --upgrade pip
          pip install \
            fastapi==0.104.1 \
            sqlalchemy==2.0.23 \
            pydantic==2.5.0 \
            pydantic-settings==2.1.0 \
            httpx==0.25.2 \
            requests==2.31.0 \
            openpyxl==3.1.2 \
            pandas==2.1.4 \
            numpy==1.25.2 \
            playwright==1.51.0

      - name: Install Playwright Chromium
        run: python -m playwright install --with-deps chromium

      - name: Consistency entrypoint gate (new entrypoints)
        run: python scripts/ci/check_entrypoint_monitoring.py --scope changed

      - name: Global change guard checklist (mandatory)
        run: python scripts/ci/check_global_change_guard.py

      - name: Monitoring guard tests
        run: python -m unittest discover -s backend/tests -p "test_monitoring_guard.py" -v

      - name: Collab triage regression
        run: python -m unittest discover -s backend/tests -p "test_collab_triage.py" -v
