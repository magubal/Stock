<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard - Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
            --accent-up: #34d399;
            --accent-down: #f87171;
            --accent-blue: #38bdf8;
            --glass-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-image:
                radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 20%);
            color: var(--text-main);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 900px;
        }

        .stock-card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Server Status */
        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: var(--input-bg);
            border-radius: 12px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-sub);
        }

        .status-dot.online {
            background: var(--accent-up);
            box-shadow: 0 0 8px var(--accent-up);
        }

        .status-dot.offline {
            background: var(--accent-down);
        }

        .data-source {
            margin-left: auto;
            font-size: 12px;
            color: var(--text-sub);
        }

        /* Search Section */
        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        input[type="text"] {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-main);
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: var(--accent-blue);
        }

        input[type="text"]::placeholder {
            color: var(--text-sub);
        }

        button.search-btn {
            background: var(--accent-blue);
            color: #0f172a;
            border: none;
            border-radius: 12px;
            padding: 0 24px;
            font-weight: 600;
            cursor: pointer;
            transition: filter 0.2s;
        }

        button.search-btn:hover {
            filter: brightness(1.1);
        }

        button.search-btn:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        .stock-hint {
            font-size: 12px;
            color: var(--text-sub);
            margin-bottom: 24px;
        }

        /* Chart Controls */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .toggle-group {
            display: flex;
            background: var(--input-bg);
            padding: 4px;
            border-radius: 8px;
        }

        .toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-sub);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .toggle-btn.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            font-weight: 600;
        }

        /* Header Info */
        .header-info {
            margin-bottom: 20px;
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
        }

        .price-info {
            font-size: 32px;
            font-weight: 700;
            margin-top: 4px;
        }

        .change {
            font-size: 16px;
            margin-left: 8px;
            font-weight: 500;
        }

        .up {
            color: var(--accent-up);
        }

        .down {
            color: var(--accent-down);
        }

        /* Chart Area */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Loading & Error */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--text-sub);
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--glass-border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-msg {
            display: none;
            text-align: center;
            padding: 16px;
            color: var(--accent-down);
            background: rgba(248, 113, 113, 0.1);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .error-msg.show {
            display: block;
        }

        /* Saved Stocks List */
        .saved-stocks {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--glass-border);
        }

        .saved-stocks h3 {
            font-size: 14px;
            color: var(--text-sub);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .stock-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .stock-tag {
            background: var(--input-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stock-tag:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: var(--accent-blue);
        }

        .stock-tag .name {
            color: var(--text-main);
        }

        .stock-tag .symbol {
            color: var(--text-sub);
            margin-left: 4px;
        }

        /* News & Issues Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--glass-border);
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }

        .info-panel {
            background: var(--input-bg);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
        }

        .info-panel h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .news-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 8px;
            /* For scrollbar spacing */
        }

        .news-list::-webkit-scrollbar {
            width: 6px;
        }

        .news-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .news-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }


        .news-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .news-item:hover {
            background: rgba(56, 189, 248, 0.1);
            border-color: var(--accent-blue);
        }

        .news-title {
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-meta {
            font-size: 12px;
            color: var(--text-sub);
            display: flex;
            gap: 8px;
        }

        .issue-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .issue-item:last-child {
            border-bottom: none;
        }

        .issue-item:hover {
            color: var(--accent-blue);
        }

        .issue-number {
            background: var(--accent-blue);
            color: #0f172a;
            width: 22px;
            height: 22px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .issue-text {
            font-size: 14px;
            line-height: 1.4;
        }

        .risk-tag {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-down);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            padding: 28px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.4;
            flex: 1;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            margin-left: 16px;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        .modal-body {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-sub);
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: var(--accent-blue);
            color: #0f172a;
            border: none;
        }

        .modal-btn.secondary {
            background: transparent;
            color: var(--text-sub);
            border: 1px solid var(--glass-border);
        }

        .loading-inline {
            color: var(--text-sub);
            font-size: 13px;
            padding: 20px;
            text-align: center;
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="stock-card">

            <!-- Server Status -->
            <div class="server-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘...</span>
                <span class="data-source" id="dataSource"></span>
            </div>

            <!-- Search -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ (ì˜ˆ: ì‚¼ì„±ì „ì, 005930, AAPL)" value="ì‚¼ì„±ì „ì">
                <button class="search-btn" id="searchBtn" onclick="fetchStockData()">ê²€ìƒ‰</button>
            </div>
            <div class="stock-hint">
                ğŸ’¡ ì¢…ëª©ëª…(ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤) ë˜ëŠ” ì½”ë“œ(005930) ë˜ëŠ” ë¯¸êµ­ í‹°ì»¤(AAPL, TSLA) ì…ë ¥
            </div>

            <div class="error-msg" id="errorMsg"></div>

            <!-- Stock Info -->
            <div class="header-info">
                <div class="company-name" id="displaySymbol">-</div>
                <div class="price-info">
                    <span id="displayPrice">-</span>
                    <span class="change" id="displayChange"></span>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="toggle-group" id="intervalGroup">
                    <button class="toggle-btn active" onclick="setMode('interval', '1d', this)">ì¼ë´‰</button>
                    <button class="toggle-btn" onclick="setMode('interval', '1wk', this)">ì£¼ë´‰</button>
                </div>
                <div class="toggle-group" id="rangeGroup">
                    <button class="toggle-btn active" onclick="setMode('range', '3mo', this)">3ê°œì›”</button>
                    <button class="toggle-btn" onclick="setMode('range', '6mo', this)">6ê°œì›”</button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <canvas id="stockChart"></canvas>
            </div>

            <!-- Saved Stocks -->
            <div class="saved-stocks">
                <h3>ğŸ“‚ ì €ì¥ëœ ì¢…ëª©</h3>
                <div class="stock-tags" id="stockTags">
                    <span style="color: var(--text-sub); font-size: 13px;">ë¡œë”© ì¤‘...</span>
                </div>
            </div>

            <!-- News & Issues Grid -->
            <div class="info-grid">
                <!-- Left: Stock News -->
                <div class="info-panel">
                    <h3>ğŸ“° <span id="newsStockName">ì¢…ëª©</span> ê´€ë ¨ ë‰´ìŠ¤</h3>
                    <div class="news-list" id="newsList">
                        <div class="loading-inline">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>

                <!-- Right: Market Issues -->
                <div class="info-panel">
                    <h3>ğŸ”¥ KITA ë¬´ì—­ë‰´ìŠ¤ & ì¦ì‹œ ë¦¬ìŠ¤í¬</h3>
                    <div id="issuesList" class="news-list">
                        <div class="loading-inline">ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="newsModal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ë‰´ìŠ¤ ì œëª©</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                ë‰´ìŠ¤ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
            <div class="modal-footer">
                <a id="modalLink" href="#" target="_blank">
                    <button class="modal-btn primary">ì›ë¬¸ ë³´ê¸° â†’</button>
                </a>
                <button class="modal-btn secondary" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== Configuration ====================
        const API_BASE = 'http://localhost:5000/api';
        const YAHOO_PROXY = 'https://api.allorigins.win/raw?url=';

        let myChart = null;
        let currentInterval = '1d';
        let currentRange = '3mo';
        let serverOnline = false;

        // ==================== Stock Name to Code Mapping ====================
        const STOCK_NAME_MAP = {
            // ëŒ€í˜•ì£¼
            'ì‚¼ì„±ì „ì': '005930', 'ì‚¼ì„±': '005930',
            'SKí•˜ì´ë‹‰ìŠ¤': '000660', 'í•˜ì´ë‹‰ìŠ¤': '000660',
            'LGì—ë„ˆì§€ì†”ë£¨ì…˜': '373220', 'LGì—ë„ˆì§€': '373220',
            'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤': '207940', 'ì‚¼ì„±ë°”ì´ì˜¤': '207940',
            'í˜„ëŒ€ì°¨': '005380', 'í˜„ëŒ€ìë™ì°¨': '005380',
            'ê¸°ì•„': '000270', 'ê¸°ì•„ì°¨': '000270',
            'ì…€íŠ¸ë¦¬ì˜¨': '068270',
            'ì‚¼ì„±SDI': '006400',
            'KBê¸ˆìœµ': '105560',
            'ì‹ í•œì§€ì£¼': '055550',
            'NAVER': '035420', 'ë„¤ì´ë²„': '035420',
            'ì¹´ì¹´ì˜¤': '035720',
            'í¬ìŠ¤ì½”í™€ë”©ìŠ¤': '005490', 'í¬ìŠ¤ì½”': '005490',
            'í˜„ëŒ€ëª¨ë¹„ìŠ¤': '012330',
            'LGí™”í•™': '051910',
            'ì‚¼ì„±ë¬¼ì‚°': '028260',
            'ì‚¼ì„±ìƒëª…': '032830',
            'SKì´ë…¸ë² ì´ì…˜': '096770',
            'SKí…”ë ˆì½¤': '017670', 'SKT': '017670',
            'KT': '030200',
            'LGì „ì': '066570',
            'í•œêµ­ì „ë ¥': '015760', 'í•œì „': '015760',
            'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°': '034020',
            'í¬ë˜í”„í†¤': '259960',
            'ì—”ì”¨ì†Œí”„íŠ¸': '036570', 'NCì†Œí”„íŠ¸': '036570',
            'ë„·ë§ˆë¸”': '251270',
            'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ': '293490',
            'ì—ì½”í”„ë¡œë¹„ì— ': '247540', 'ì—ì½”í”„ë¡œ': '086520',
            'í¬ìŠ¤ì½”í“¨ì²˜ì— ': '003670',
            'í•œë¯¸ë°˜ë„ì²´': '042700',
            'ë¦¬ë…¸ê³µì—…': '058470',
            'HLB': '028300',
            'ì•Œí…Œì˜¤ì  ': '196170',
            'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤': '012450', 'í•œí™”ì—ì–´ë¡œ': '012450',
        };

        function resolveSymbol(input) {
            const trimmed = input.trim();
            // ì¢…ëª©ëª… ë§¤í•‘ì— ìˆìœ¼ë©´ ì½”ë“œë¡œ ë³€í™˜
            if (STOCK_NAME_MAP[trimmed]) {
                return STOCK_NAME_MAP[trimmed];
            }
            // 6ìë¦¬ ìˆ«ìë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
            if (/^\d{6}$/.test(trimmed)) {
                return trimmed;
            }
            // ì˜ë¬¸ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ë¯¸êµ­ ì£¼ì‹)
            return trimmed.toUpperCase();
        }

        // ==================== Initialization ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await checkServerStatus();
            loadSavedStocks();
            fetchStockData();

            // ì—”í„° í‚¤ë¡œ ê²€ìƒ‰
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    fetchStockData();
                }
            });
        });

        // ==================== Server Status ====================
        async function checkServerStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            try {
                const response = await fetch(`${API_BASE}/health`, { timeout: 3000 });
                if (response.ok) {
                    serverOnline = true;
                    statusDot.className = 'status-dot online';
                    statusText.textContent = 'ğŸŸ¢ ë¡œì»¬ ì„œë²„ ì—°ê²°ë¨ (SQLite ì €ì¥ í™œì„±í™”)';
                }
            } catch (e) {
                serverOnline = false;
                statusDot.className = 'status-dot offline';
                statusText.textContent = 'ğŸ”´ ë¡œì»¬ ì„œë²„ êº¼ì§ (Yahooì—ì„œ ì§ì ‘ ë¡œë“œ)';
            }
        }

        // ==================== Mode Toggle ====================
        function setMode(type, value, element) {
            if (type === 'interval') currentInterval = value;
            if (type === 'range') currentRange = value;

            const group = element.parentElement;
            group.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');

            fetchStockData();
        }

        // ==================== UI Helpers ====================
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
            document.getElementById('searchBtn').disabled = show;
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMsg');
            if (message) {
                errorEl.textContent = message;
                errorEl.classList.add('show');
            } else {
                errorEl.classList.remove('show');
            }
        }

        function updateDataSource(source) {
            document.getElementById('dataSource').textContent = `ë°ì´í„°: ${source}`;
        }

        // ==================== Main Data Fetch ====================
        async function fetchStockData() {
            const rawInput = document.getElementById('searchInput').value.trim();
            if (!rawInput) {
                showError('ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì¢…ëª©ëª…ì„ ì½”ë“œë¡œ ë³€í™˜
            const symbol = resolveSymbol(rawInput);

            showLoading(true);
            showError(null);

            if (serverOnline) {
                await fetchFromLocalServer(symbol);
            } else {
                await fetchFromYahoo(symbol);
            }

            showLoading(false);
        }

        // ==================== Local Server API ====================
        async function fetchFromLocalServer(symbol) {
            try {
                const url = `${API_BASE}/stock/${symbol}?interval=${currentInterval}&range=${currentRange}`;
                const response = await fetch(url);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                updateDisplay(data.name, symbol, data.currentPrice, data.priceChange, data.percentChange, data.currency);
                drawChart(data.labels, data.prices, data.currency);
                updateDataSource(`SQLite (${data.recordCount}ê±´)`);
                loadSavedStocks(); // Refresh saved list

                // ë‰´ìŠ¤ ë° ì‹œì¥ ì´ìŠˆ ë¡œë“œ
                loadStockNews(symbol, data.name);
                loadMarketIssues();

            } catch (error) {
                console.error('Local server error:', error);
                showError(`âš ï¸ ${error.message}`);
            }
        }

        // ==================== Yahoo Finance Direct ====================
        async function fetchFromYahoo(symbol) {
            let yahooSymbol = symbol;
            if (/^\d{6}$/.test(symbol)) {
                yahooSymbol = symbol + '.KS';
            }

            const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=${currentInterval}&range=${currentRange}`;
            const proxyUrl = `${YAHOO_PROXY}${encodeURIComponent(yahooUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();

                if (data.chart.error) {
                    // Try KOSDAQ
                    if (yahooSymbol.endsWith('.KS')) {
                        yahooSymbol = symbol + '.KQ';
                        const retryUrl = `${YAHOO_PROXY}${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?interval=${currentInterval}&range=${currentRange}`)}`;
                        const retryResponse = await fetch(retryUrl);
                        const retryData = await retryResponse.json();

                        if (retryData.chart.error) {
                            throw new Error('ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }

                        processYahooData(retryData.chart.result[0], symbol);
                        return;
                    }
                    throw new Error(data.chart.error.description);
                }

                processYahooData(data.chart.result[0], symbol);

            } catch (error) {
                console.error('Yahoo fetch error:', error);
                showError(`âš ï¸ ${error.message}`);
            }
        }

        function processYahooData(result, symbol) {
            const meta = result.meta;
            const timestamps = result.timestamp || [];
            const quotes = result.indicators.quote[0];

            const labels = timestamps.map(ts => new Date(ts * 1000).toISOString().slice(0, 10));
            const prices = quotes.close.map(p => p !== null ? Math.round(p) : null);

            const currentPrice = meta.regularMarketPrice;
            const previousClose = meta.chartPreviousClose || meta.previousClose || currentPrice;
            const priceChange = currentPrice - previousClose;
            const percentChange = ((priceChange / previousClose) * 100).toFixed(2);

            updateDisplay(meta.shortName || meta.symbol, symbol, currentPrice, priceChange, percentChange, meta.currency);
            drawChart(labels, prices, meta.currency);
            updateDataSource('Yahoo Finance (ì‹¤ì‹œê°„)');
        }

        // ==================== Display Update ====================
        function updateDisplay(name, symbol, price, change, percent, currency) {
            document.getElementById('displaySymbol').textContent = `${name} (${symbol})`;
            document.getElementById('displayPrice').textContent = price.toLocaleString(undefined, { maximumFractionDigits: 0 }) + ' ' + (currency || '');

            const changeEl = document.getElementById('displayChange');
            const isUp = change >= 0;
            changeEl.textContent = `${isUp ? '+' : ''}${change.toLocaleString(undefined, { maximumFractionDigits: 0 })} (${isUp ? '+' : ''}${percent}%)`;
            changeEl.className = `change ${isUp ? 'up' : 'down'}`;
        }

        // ==================== Chart Drawing ====================
        function drawChart(labels, prices, currency) {
            const ctx = document.getElementById('stockChart').getContext('2d');

            if (myChart) myChart.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(56, 189, 248, 0.5)');
            gradient.addColorStop(1, 'rgba(56, 189, 248, 0.0)');

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì£¼ê°€',
                        data: prices,
                        borderColor: '#38bdf8',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true,
                        tension: 0.1,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#94a3b8',
                            bodyColor: '#f8fafc',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            displayColors: false,
                            callbacks: {
                                label: ctx => (ctx.parsed.y || 0).toLocaleString() + ' ' + (currency || 'KRW')
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', maxTicksLimit: 6, maxRotation: 0 }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#64748b',
                                callback: v => v.toLocaleString()
                            }
                        }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }

        // ==================== Saved Stocks List ====================
        async function loadSavedStocks() {
            const container = document.getElementById('stockTags');

            if (!serverOnline) {
                container.innerHTML = '<span style="color: var(--text-sub); font-size: 13px;">ì„œë²„ê°€ êº¼ì ¸ ìˆì–´ ì €ì¥ëœ ì¢…ëª©ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/stocks`);
                const data = await response.json();

                if (data.stocks && data.stocks.length > 0) {
                    container.innerHTML = data.stocks.map(s => `
                        <div class="stock-tag" onclick="selectStock('${s.symbol}')">
                            <span class="name">${s.name}</span>
                            <span class="symbol">(${s.symbol})</span>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<span style="color: var(--text-sub); font-size: 13px;">ì•„ì§ ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</span>';
                }
            } catch (e) {
                container.innerHTML = '<span style="color: var(--text-sub); font-size: 13px;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>';
            }
        }

        function selectStock(symbol) {
            document.getElementById('searchInput').value = symbol;
            fetchStockData();
        }

        // ==================== News Loading ====================
        let currentSymbol = '';

        async function loadStockNews(symbol, stockName) {
            currentSymbol = symbol;
            const container = document.getElementById('newsList');
            const nameSpan = document.getElementById('newsStockName');

            nameSpan.textContent = stockName || symbol;
            container.innerHTML = '<div class="loading-inline">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            if (!serverOnline) {
                container.innerHTML = '<div class="loading-inline">ì„œë²„ ì—°ê²° í•„ìš”</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/news/${symbol}`);
                const data = await response.json();

                if (data.success && data.news && data.news.length > 0) {
                    container.innerHTML = data.news.map(item => `
                        <div class="news-item" onclick="window.open('${item.link}', '_blank')">
                            <div class="news-title">${item.title}</div>
                            <div class="news-meta">
                                <span>${item.source}</span>
                                <span>â€¢</span>
                                <span>${item.time}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<div class="loading-inline">ê´€ë ¨ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (e) {
                console.error('News fetch error:', e);
                container.innerHTML = '<div class="loading-inline">ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        async function loadMarketIssues() {
            const container = document.getElementById('issuesList');
            container.innerHTML = '<div class="loading-inline">ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            if (!serverOnline) {
                container.innerHTML = '<div class="loading-inline">ì„œë²„ ì—°ê²° í•„ìš”</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/market-issues`);
                const data = await response.json();

                let html = '';

                // KITA ë¬´ì—­ë‰´ìŠ¤ (í•µì‹¬ ì´ìŠˆ)
                if (data.issues && data.issues.length > 0) {
                    data.issues.forEach((item, index) => {
                        html += `
                            <div class="issue-item" onclick="window.open('${item.link}', '_blank')">
                                <span class="issue-number">${index + 1}</span>
                                <div style="flex: 1;">
                                    <div class="issue-text">${item.title}</div>
                                    <div style="font-size: 11px; color: var(--text-sub); margin-top: 4px;">
                                        ${item.source} â€¢ ${item.time}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                // ì¦ì‹œ ë¦¬ìŠ¤í¬
                if (data.risks && data.risks.length > 0) {
                    html += '<div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid var(--glass-border);"><small style="color: var(--accent-down);">âš ï¸ ì¦ì‹œ ë¦¬ìŠ¤í¬ & í•˜ë½ ìš”ì¸</small></div>';
                    data.risks.forEach(item => {
                        html += `
                            <div class="issue-item" onclick="window.open('${item.link}', '_blank')" style="color: var(--accent-down);">
                                <div style="flex: 1;">
                                    <div class="issue-text">${item.title}<span class="risk-tag">ë¦¬ìŠ¤í¬</span></div>
                                    <div style="font-size: 11px; color: var(--text-sub); margin-top: 4px;">
                                        ${item.source || 'News'} â€¢ ${item.time || ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html || '<div class="loading-inline">ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            } catch (e) {
                console.error('Issues fetch error:', e);
                container.innerHTML = '<div class="loading-inline">ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ==================== Modal ====================
        function openModal(title, description, link) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').textContent = description || 'ìƒì„¸ ë‚´ìš©ì€ ì›ë¬¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”.';
            document.getElementById('modalLink').href = link || '#';
            document.getElementById('newsModal').classList.add('show');
        }

        function closeModal(event) {
            if (!event || event.target === document.getElementById('newsModal')) {
                document.getElementById('newsModal').classList.remove('show');
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, ' ');
        }

    </script>
</body>

</html>